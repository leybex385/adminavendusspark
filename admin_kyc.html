<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avendus Capital - Admin Suite</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>const supabasejs = window.supabase;</script>
    <script src="db.js"></script>
    <script src="db_patch.js"></script>
    <script src="js/admin_auth_guard.js"></script>
    <script src="js/admin_i18n.js"></script>
    <style>
        :root {
            --sidebar-bg: #ffffff;
            --main-bg: #f5f7fb;
            --primary-orange: #f97316;
            --primary-blue: #3b82f6;
            --primary-green: #10b981;
            --border-color: #e2e8f0;
            --text-dark: #1e293b;
            --text-muted: #64748b;
        }

        body {
            background-color: var(--main-bg);
            color: var(--text-dark);
            font-family: 'Inter', sans-serif;
            margin: 0;
            display: flex;
            overflow-x: hidden;
            height: 100vh;
        }

        aside {
            width: 260px;
            background: white;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .logo-area {
            padding: 20px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .logo-box {
            width: 30px;
            height: 30px;
            background: #6366f1;
            border-radius: 6px;
        }

        .nav-menu {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.85rem;
            border-radius: 8px;
            margin-bottom: 2px;
            cursor: pointer;
        }

        .menu-item:hover,
        .menu-item.active {
            background: #eff6ff;
            color: #3b82f6;
            font-weight: 600;
        }

        .sub-menu {
            padding-left: 40px;
            display: none;
            margin: 5px 0;
        }

        .sub-menu.show {
            display: block;
        }

        .sub-item {
            padding: 8px 0;
            color: var(--text-muted);
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sub-item:hover,
        .sub-item.active {
            color: var(--primary-orange);
        }

        /* Premium Language Switcher */
        .lang-switcher {
            display: flex;
            gap: 8px;
            margin-right: 15px;
            align-items: center;
        }

        .lang-btn {
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            padding: 4px 10px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            filter: grayscale(1);
            opacity: 0.6;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .lang-btn:hover {
            background: rgba(249, 115, 22, 0.1);
            opacity: 0.9;
            transform: scale(1.1);
        }

        .lang-btn.active {
            filter: grayscale(0);
            opacity: 1;
            background: #ffffff;
            border-color: #f97316;
            box-shadow: 0 2px 8px rgba(249, 115, 22, 0.2);
            transform: scale(1.1);
        }

        main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            background: white;
            border-bottom: 1px solid var(--border-color);
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 0 30px;
            gap: 20px;
        }

        .page-tabs {
            background: #fdfdfd;
            padding: 5px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 5px;
            overflow-x: auto;
        }

        .tab-tag {
            padding: 6px 15px;
            border: 1px solid var(--border-color);
            font-size: 0.75rem;
            border-radius: 4px;
            background: white;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            white-space: nowrap;
        }

        .tab-tag.active {
            border-color: var(--primary-orange);
            color: var(--primary-orange);
        }

        .container {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .section-card {
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            padding: 20px;
            min-height: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }

        .vsl-table-wrap {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-top: 10px;
        }

        /* Unified Buttons */
        .vsl-btn {
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid var(--border-color);
            background: white;
        }

        .vsl-btn.active {
            border-color: var(--primary-orange);
            color: var(--primary-orange);
        }

        .vsl-btn.orange {
            background: var(--primary-orange);
            color: white;
            border: none;
        }

        .vsl-btn.green {
            background: var(--primary-green);
            color: white;
            border: none;
        }

        /* VSL Framework Classes */
        .vsl-page {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .vsl-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .vsl-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-dark);
            margin: 0;
        }

        .vsl-btn-primary {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .vsl-btn-primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .vsl-btn-primary:active {
            transform: translateY(0);
        }

        .vsl-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 5000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .vsl-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .vsl-input:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Messaging Center Custom */
        .msg-layout {
            display: flex;
            gap: 0;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            height: 600px;
            margin-top: 15px;
        }

        .msg-list-pane {
            width: 380px;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .msg-search-box {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .msg-search-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.8rem;
            outline: none;
            box-sizing: border-box;
        }

        .msg-items-scroll {
            flex-grow: 1;
            overflow-y: auto;
        }

        .msg-row {
            padding: 15px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: 0.2s;
        }

        .msg-row:hover {
            background: #f8fafc;
        }

        .msg-row.active {
            background: #fff7ed;
            border-left: 3px solid var(--primary-orange);
        }

        .msg-row-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .msg-row-title {
            font-weight: 700;
            font-size: 0.9rem;
            color: #1e293b;
        }

        .msg-row-date {
            font-size: 0.7rem;
            color: #94a3b8;
        }

        .msg-row-preview {
            font-size: 0.8rem;
            color: #64748b;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .msg-content-pane {
            flex-grow: 1;
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: #94a3b8;
            overflow-y: auto;
        }

        .msg-view-header {
            width: 100%;
            text-align: left;
            padding-bottom: 20px;
            border-bottom: 1px solid #f1f5f9;
            margin-bottom: 20px;
        }

        /* Stencil Specifics */
        .stencil-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .stencil-card {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            background: white;
            cursor: pointer;
            transition: 0.2s;
            position: relative;
            text-align: left;
        }

        .stencil-card:hover {
            border-color: var(--primary-orange);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .stencil-card h4 {
            margin: 0 0 10px 0;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #1e293b;
        }

        .stencil-tag {
            font-size: 0.7rem;
            color: #94a3b8;
            margin-bottom: 10px;
            display: block;
        }

        .stencil-preview {
            font-size: 0.8rem;
            color: #64748b;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.5;
        }

        .filter-group {
            display: flex;
            gap: 10px;
        }

        .filter-btn {
            padding: 4px 12px;
            font-size: 0.7rem;
            border-radius: 4px;
            background: #e0f2fe;
            color: #0369a1;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }

        .filter-btn.active {
            background: #0ea5e9;
            color: white;
        }

        .loader {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }

        /* KYC Edit Modal Specifics */
        .kyc-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .kyc-modal-card {
            background: white;
            width: 800px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-size: 0.85rem;
        }

        .kyc-modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            color: #1e293b;
            font-size: 1rem;
        }

        .kyc-modal-body {
            padding: 25px;
            overflow-y: auto;
            max-height: 80vh;
        }

        .kyc-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .kyc-form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }

        .kyc-form-group label {
            color: #64748b;
            font-weight: 500;
            font-size: 0.8rem;
        }

        .kyc-input {
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            outline: none;
            transition: 0.2s;
            font-family: inherit;
        }

        .kyc-input:focus {
            border-color: var(--primary-orange);
        }

        /* KYC Verification (Table Page) Specifics */
        .kyc-verify-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .kyc-verify-filters {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            flex-grow: 1;
            margin-right: 20px;
        }

        .kyc-filter-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .kyc-filter-item label {
            font-size: 0.75rem;
            color: #1e293b;
            font-weight: 500;
        }

        .kyc-filter-input {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.8rem;
            background: white;
        }

        .kyc-status-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .kyc-status-pill {
            padding: 6px 15px;
            font-size: 0.75rem;
            border-radius: 6px;
            background: white;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: 0.2s;
            font-weight: 500;
            color: #64748b;
        }

        .kyc-status-pill:hover {
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .kyc-status-pill.active {
            background: #eff6ff;
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .kyc-table-img {
            width: 50px;
            height: 35px;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
            object-fit: cover;
            background: #f8fafc;
            cursor: pointer;
        }

        .kyc-refresh-btn {
            background: #f97316;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .kyc-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 700;
            font-size: 0.65rem;
            text-transform: uppercase;
        }

        .kyc-badge.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .kyc-badge.approved {
            background: #dcfce7;
            color: #166534;
        }

        .kyc-badge.reject {
            background: #fee2e2;
            color: #991b1b;
        }

        .kyc-image-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 10px;
        }

        .kyc-img-box {
            border: 1px dashed #cbd5e1;
            border-radius: 8px;
            height: 220px;
            background: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }

        .kyc-img-box:hover {
            border-color: var(--primary-orange);
            background: #f1f5f9;
        }

        .kyc-plus-icon {
            color: #94a3b8;
            width: 32px;
            height: 32px;
        }

        .kyc-img-box img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
        }

        .kyc-img-remove {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border-radius: 4px;
            padding: 4px;
            cursor: pointer;
            display: none;
            z-index: 5;
        }

        .kyc-img-box:hover .kyc-img-remove {
            display: block;
        }

        .kyc-img-hint {
            font-size: 0.7rem;
            color: #94a3b8;
            margin-top: 8px;
            line-height: 1.4;
        }

        .kyc-status-warning {
            background: #fff7ed;
            border: 1px solid #ffedd5;
            padding: 12px;
            border-radius: 8px;
            color: #9a3412;
            font-size: 0.8rem;
            margin-top: 20px;
        }

        .kyc-modal-footer {
            padding: 20px;
            border-top: 1px solid #f1f5f9;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .vsl-btn.submit {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 25px;
            font-weight: 600;
        }

        .vsl-btn.cancel {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 25px;
            font-weight: 600;
        }

        /* Edit btn hover */
        .btn-edit-wrap {
            position: relative;
            display: inline-block;
        }

        .btn-edit-wrap:hover::after {
            content: 'Edit';
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            padding: 4px 8px;
            font-size: 0.7rem;
            border-radius: 4px;
            z-index: 10;
            pointer-events: none;
        }

        /* Custom Success Modal Styling */
        .success-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.75);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(6px);
            transition: all 0.3s ease;
        }

        .success-modal-card {
            background: white;
            width: 380px;
            padding: 35px 25px;
            border-radius: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .success-modal-overlay.active {
            display: flex;
        }

        .success-modal-overlay.active .success-modal-card {
            transform: scale(1);
            opacity: 1;
        }

        .success-modal-icon-box {
            width: 72px;
            height: 72px;
            background: #ecfdf5;
            color: #10b981;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .success-modal-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #1e293b;
            margin: 0 0 10px 0;
        }

        .success-modal-message {
            font-size: 0.95rem;
            color: #64748b;
            line-height: 1.5;
            margin: 0 0 25px 0;
        }

        .success-modal-btn {
            width: 100%;
            padding: 12px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .success-modal-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.2);
        }

        /* Custom Confirm Modal Styling */
        .confirm-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.75);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            backdrop-filter: blur(6px);
            transition: all 0.3s ease;
        }

        .confirm-modal-card {
            background: white;
            width: 400px;
            padding: 35px 25px;
            border-radius: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .confirm-modal-overlay.active {
            display: flex;
        }

        .confirm-modal-overlay.active .confirm-modal-card {
            transform: scale(1);
            opacity: 1;
        }

        .confirm-modal-icon-box {
            width: 72px;
            height: 72px;
            background: #fff1f2;
            color: #e11d48;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .confirm-modal-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #1e293b;
            margin: 0 0 10px 0;
        }

        .confirm-modal-message {
            font-size: 0.95rem;
            color: #64748b;
            line-height: 1.5;
            margin: 0 0 25px 0;
        }

        .confirm-modal-footer {
            display: flex;
            gap: 12px;
            width: 100%;
        }

        .confirm-modal-btn {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .confirm-modal-btn.cancel {
            background: #f1f5f9;
            color: #64748b;
        }

        .confirm-modal-btn.cancel:hover {
            background: #e2e8f0;
        }

        .confirm-modal-btn.delete {
            background: #ef4444;
            color: white;
        }

        .confirm-modal-btn.delete:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.2);
        }
    </style>
</head>

<body>
    <div class="loader" id="vslLoader"><i data-lucide="loader-2" class="animate-spin" size="48"></i></div>

    <aside>
        <div class="logo-area">
            <div class="logo-box"></div> Avendus Capital
        </div>
        <nav class="nav-menu">
            <div class="menu-item active" id="btn_home" onclick="switchPage('home')"><i data-lucide="home"
                    size="18"></i> front page</div>
            <div class="menu-item" id="btn_kyc" onclick="switchPage('kyc')"><i data-lucide="user-check" size="18"></i>
                Real-name authentication</div>
            <div class="menu-item" id="btn_users" onclick="switchPage('users')"><i data-lucide="users" size="18"></i>
                Customer Management</div>
            <div class="menu-item" id="btn_bank_accounts" onclick="switchPage('bank_accounts')"><i
                    data-lucide="credit-card" size="18"></i>
                Bank Accounts</div>
            <div class="menu-item" id="btn_products" onclick="switchPage('products')"><i data-lucide="box"
                    size="18"></i> Product Management</div>
            <div class="menu-item" id="btn_stock057" onclick="switchPage('stock057')"><i data-lucide="trending-up"
                    size="18"></i> Institutional Stock 057</div>
            <div class="menu-item" onclick="toggleSub('subFinancial')"><i data-lucide="wallet" size="18"></i> Financial
                Management <i data-lucide="chevron-down" size="14" style="margin-left:auto;"></i></div>
            <div class="sub-menu" id="subFinancialSub">
                <div class="sub-item" id="btn_deposits" onclick="switchPage('deposits')">Deposit records</div>

                <!-- New Withdrawals Management Section -->
                <div class="sub-item" onclick="toggleSub('withdrawals')" style="color: #3b82f6; font-weight: 600;">
                    <i data-lucide="external-link" size="14"></i> Withdrawals
                    <i data-lucide="chevron-down" size="14" style="margin-left:auto;"></i>
                </div>
                <div class="sub-menu" id="withdrawalsSub" style="padding-left: 20px;">
                    <div class="sub-item" id="btn_withdrawals" onclick="switchPage('withdrawals')"
                        style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 6px; padding: 10px; margin: 5px 0; color: #1d4ed8; font-weight: 700; justify-content: center;">
                        Withdrawal Requests
                    </div>
                </div>

                <div class="sub-item" id="btn_loans" onclick="switchPage('loans')">Loan records</div>
                <div class="sub-item" id="btn_rewards" onclick="switchPage('rewards')">Bonus Points Record</div>
            </div>
            <div class="menu-item" onclick="toggleSub('transaction')"><i data-lucide="repeat" size="18"></i> Transaction
                records <i data-lucide="chevron-down" size="14" style="margin-left:auto;"></i></div>
            <div class="sub-menu" id="transactionSub">
                <div class="sub-item" id="btn_stock" onclick="switchPage('stock')">Stock trading</div>
                <div class="sub-item" id="btn_bulk" onclick="switchPage('bulk')">Large transactions</div>
                <div class="sub-item" id="btn_ipo" onclick="switchPage('ipo')">IPO</div>
                <div class="sub-item" id="btn_fund" onclick="switchPage('fund')">Fund trading</div>
                <div class="sub-item" id="btn_quant" onclick="switchPage('quant')">Quantitative Trading</div>
            </div>
            <div
                style="padding: 15px 15px 5px 15px; font-size: 0.65rem; color: #94a3b8; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
                Communication</div>
            <div class="menu-item" id="btn_messages" onclick="switchPage('messages')"><i data-lucide="send"
                    size="18"></i> Notification Center</div>
            <div class="menu-item" id="btn_livechat" onclick="switchPage('livechat')">
                <i data-lucide="message-circle" size="18"></i> Customer Service Support
                <span id="chat_badge"
                    style="display:none; background:#ef4444; color:white; font-size:10px; padding:2px 6px; border-radius:10px; margin-left:auto; min-width: 15px; text-align: center; font-weight: 700; box-shadow: 0 0 0 rgba(239, 68, 68, 0.4); animation: pulse-red-admin 2s infinite;">0</span>
            </div>

            <style>
                @keyframes pulse-red-admin {
                    0% {
                        transform: scale(0.95);
                        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
                    }

                    70% {
                        transform: scale(1);
                        box-shadow: 0 0 0 6px rgba(239, 68, 68, 0);
                    }

                    100% {
                        transform: scale(0.95);
                        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
                    }
                }

                .admin-user-menu {
                    position: relative;
                    display: inline-block;
                    cursor: pointer;
                }

                .admin-trigger {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    padding: 5px;
                    border-radius: 20px;
                    transition: background 0.2s;
                }

                .admin-trigger:hover {
                    background: #f1f5f9;
                }

                .admin-avatar {
                    width: 32px;
                    height: 32px;
                    background: #3b82f6;
                    color: white;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: 700;
                    font-size: 0.85rem;
                }

                .dropdown-arrow {
                    font-size: 0.7rem;
                    color: #64748b;
                }

                .admin-dropdown {
                    display: none;
                    position: absolute;
                    top: 100%;
                    right: 0;
                    background: white;
                    min-width: 160px;
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                    border: 1px solid #e2e8f0;
                    border-radius: 8px;
                    padding: 5px 0;
                    z-index: 1000;
                    margin-top: 5px;
                }

                .admin-dropdown.active {
                    display: block;
                }

                .admin-dropdown a,
                .admin-dropdown button {
                    display: block;
                    width: 100%;
                    padding: 10px 15px;
                    text-align: left;
                    background: none;
                    border: none;
                    color: #1e293b;
                    font-size: 0.9rem;
                    cursor: pointer;
                    text-decoration: none;
                    box-sizing: border-box;
                    font-family: inherit;
                }

                .admin-dropdown a:hover,
                .admin-dropdown button:hover {
                    background: #f8fafc;
                    color: #3b82f6;
                }

                .admin-dropdown hr {
                    border: 0;
                    border-top: 1px solid #e2e8f0;
                    margin: 5px 0;
                }
            </style>
        </nav>
    </aside>

    <main>
        <header>
            <div style="display:flex; align-items:center; gap:15px; margin-left:auto;">
                <button onclick="init()"
                    style="background:none; border:none; color:#f97316; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:5px;">
                    <i data-lucide="refresh-cw" size="14"></i>
                </button>

                <div class="admin-user-menu" id="adminUserMenu">
                    <div class="admin-trigger" onclick="toggleAdminMenu()">
                        <div class="admin-avatar">AD</div>
                        <span class="dropdown-arrow">â–¼</span>
                    </div>

                    <div class="admin-dropdown" id="adminDropdown">
                        <a href="admin_settings_account.html">Account Settings</a>
                        <a href="admin_settings_account.html#security">Security</a>
                        <hr>
                        <button id="dropdownLogoutBtn" onclick="adminLogout()">Logout</button>
                    </div>
                </div>
            </div>

            <script>
                function toggleAdminMenu() {
                    document.getElementById('adminDropdown').classList.toggle('active');
                }
                // Close dropdown when clicking outside
                window.addEventListener('click', function (e) {
                    const menu = document.getElementById('adminUserMenu');
                    const dropdown = document.getElementById('adminDropdown');
                    if (menu && !menu.contains(e.target)) {
                        dropdown.classList.remove('active');
                    }
                });
            </script>
        </header>

        <div class="page-tabs" id="tabContainer"></div>

        <div class="container">
            <!-- DYNAMIC PAGES -->
            <div id="pageHome" class="vsl-page">
                <div class="section-card">
                    <h3>Dashboard Summary</h3>
                    <div id="stat_summary" style="display:flex; gap:20px;"></div>
                </div>
            </div>

            <div id="pageBankAccounts" class="vsl-page" style="display:none;">
                <div class="section-card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h2>User Bank Accounts</h2>
                        <button class="vsl-btn orange" onclick="loadBankAccounts()"><i data-lucide="refresh-cw"
                                size="14"></i> Refresh</button>
                    </div>
                    <div style="overflow-x:auto; margin-top:20px;">
                        <table style="width:100%; border-collapse:collapse; font-size:0.85rem;">
                            <thead>
                                <tr style="background:#f8fafc; text-align:left; color:#64748b;">
                                    <th style="padding:12px;">User ID</th>
                                    <th style="padding:12px;">Account Holder</th>
                                    <th style="padding:12px;">Bank Name</th>
                                    <th style="padding:12px;">Account No.</th>
                                    <th style="padding:12px;">IFSC</th>
                                    <th style="padding:12px;">Mobile</th>
                                    <th style="padding:12px;">Date Added</th>
                                </tr>
                            </thead>
                            <tbody id="bankAccountsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="pageMessages" class="vsl-page" style="display:none;">
                <div class="section-card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h2 style="font-size:1.1rem; margin:0;">Notification Center</h2>
                        <div style="display:flex; gap:10px;">
                            <button class="vsl-btn orange" onclick="init()"><i data-lucide="refresh-cw" size="14"></i>
                                refresh</button>
                            <button class="vsl-btn green" onclick="openMsgModal()">Create a new notification</button>
                        </div>
                    </div>

                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
                        <div style="display:flex; gap:10px;">
                            <button class="vsl-btn active" id="btn_sent" onclick="showMsgSection('sent')">Sent</button>
                            <button class="vsl-btn" id="btn_stencil"
                                onclick="showMsgSection('stencil')">Stencil</button>
                        </div>
                        <div class="filter-group" id="stencilFilters" style="display:none;">
                            <button class="filter-btn active">all</button>
                            <button class="filter-btn">SPO</button>
                            <button class="filter-btn">CONDITION</button>
                        </div>
                    </div>

                    <div id="msgMain" class="msg-layout">
                        <div class="msg-list-pane">
                            <div class="msg-search-box">
                                <input type="text" id="msgSearch" class="msg-search-input" placeholder="Search title..."
                                    oninput="filterMessages()">
                            </div>
                            <div class="msg-items-scroll" id="sentMsgs"></div>
                        </div>
                        <div class="msg-content-pane" id="msgContentArea">
                            <p>Please select one notification to view.</p>
                        </div>
                    </div>

                    <div id="msgStencilView" style="display:none;">
                        <div class="stencil-grid" id="stencilGrid"></div>
                    </div>
                </div>
            </div>

            <!-- Page: Live Chat Support -->
            <div id="pageLivechat" class="vsl-page" style="display:none;">
                <div class="section-card"
                    style="padding: 0; display: flex; flex-direction: column; overflow: hidden; height: calc(100vh - 180px); border-radius: 12px;">
                    <div class="msg-layout" style="height: 100%; margin-top: 0; border: none; border-radius: 0;">
                        <!-- Sidebar: User List -->
                        <div class="msg-list-pane"
                            style="width: 320px; background: #fff; border-right: 1px solid #f1f5f9;">
                            <div class="msg-search-box"
                                style="padding: 20px; background: #fff; border-bottom: 1px solid #f1f5f9;">
                                <h2 style="font-size: 1.1rem; margin: 0 0 15px 0; color: #1e293b; font-weight: 700;">
                                    Chat Support</h2>
                                <div style="position: relative;">
                                    <i data-lucide="search" size="14"
                                        style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8;"></i>
                                    <input type="text" id="chatSearch" class="msg-search-input"
                                        placeholder="Search user..." oninput="filterChatUsers()"
                                        style="padding-left: 35px; background: #f8fafc; border: 1px solid #e2e8f0;">
                                </div>
                            </div>
                            <div class="msg-items-scroll" id="chatUserList" style="background: #fff;">
                                <!-- User list for chat -->
                            </div>
                        </div>

                        <!-- Main: Chat Window -->
                        <div class="msg-content-pane"
                            style="flex: 1; padding: 0; display: flex; flex-direction: column; background: #fff; align-items: stretch;">
                            <!-- Chat Header -->
                            <div id="chatWindowHeader"
                                style="padding: 15px 25px; border-bottom: 1px solid #f1f5f9; background: #fff; display: none; align-items: center; justify-content: space-between; width: 100%; box-sizing: border-box;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #eff6ff; color: #3b82f6; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1rem;"
                                        id="chatHeaderAvatar">U</div>
                                    <div>
                                        <div style="font-weight: 700; color: #1e293b; font-size: 0.95rem;"
                                            id="chatHeaderName">Investor</div>
                                        <div
                                            style="font-size: 0.75rem; color: #10b981; display: flex; align-items: center; gap: 4px;">
                                            <span
                                                style="width: 6px; height: 6px; border-radius: 50%; background: #10b981;"></span>
                                            Online
                                        </div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button class="vsl-btn" onclick="initLiveChat()" title="Refresh Chat"><i
                                            data-lucide="refresh-cw" size="14"></i></button>
                                </div>
                            </div>

                            <div id="chatHistory"
                                style="flex: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; gap: 12px; background: #fcfdfe; width: 100%; box-sizing: border-box;">
                                <div
                                    style="height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #94a3b8; gap: 15px;">
                                    <i data-lucide="message-square" size="48" style="opacity: 0.2;"></i>
                                    <div style="font-size: 0.9rem;">Select a user to start chatting</div>
                                </div>
                            </div>

                            <div id="chatInputArea"
                                style="padding: 20px 25px; border-top: 1px solid #f1f5f9; display: none; gap: 12px; background: #fff; align-items: center; width: 100%; box-sizing: border-box;">
                                <div style="flex: 1; position: relative;">
                                    <input type="text" id="adminChatInput" class="msg-search-input"
                                        placeholder="Write your message..."
                                        onkeypress="if(event.key === 'Enter') sendAdminChat()"
                                        style="border-radius: 25px; padding: 12px 20px; background: #f8fafc; border: 1px solid #e2e8f0; width: 100%; box-sizing: border-box;">
                                </div>
                                <button class="vsl-btn orange" onclick="sendAdminChat()"
                                    style="border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; padding: 0; flex-shrink: 0;">
                                    <i data-lucide="send" size="18"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STUBS FOR OTHERS -->
            <div id="pageKyc" class="vsl-page" style="display:none;">
                <div class="section-card">
                    <div class="kyc-verify-header">
                        <div class="kyc-verify-filters">
                            <div class="kyc-filter-item">
                                <label>Username</label>
                                <input type="text" id="kf_user" class="kyc-filter-input"
                                    placeholder="Please enter your username" oninput="filterKyc()">
                            </div>
                            <div class="kyc-filter-item">
                                <label>Customer's Full Name</label>
                                <input type="text" id="kf_name" class="kyc-filter-input"
                                    placeholder="Please enter the customer's full name" oninput="filterKyc()">
                            </div>
                            <div class="kyc-filter-item">
                                <label>Customer-Verified Mobile Phone Number</label>
                                <input type="text" id="kf_phone" class="kyc-filter-input"
                                    placeholder="Please enter your verified mobile phone number" oninput="filterKyc()">
                            </div>
                            <div class="kyc-filter-item">
                                <label>Salesperson</label>
                                <input type="text" id="kf_sales" class="kyc-filter-input"
                                    placeholder="Please enter the business name" oninput="filterKyc()">
                            </div>
                        </div>
                        <button class="kyc-refresh-btn" onclick="init()"><i data-lucide="refresh-cw" size="16"></i>
                            refresh</button>
                    </div>

                    <div class="kyc-status-bar">
                        <div class="kyc-status-pill active" onclick="setStatusFilter('all', this)">all</div>
                        <div class="kyc-status-pill" onclick="setStatusFilter('Approved', this)">Approved</div>
                        <div class="kyc-status-pill" onclick="setStatusFilter('Rejected', this)">reject</div>
                        <div class="kyc-status-pill" onclick="setStatusFilter('Pending', this)">Pending review</div>
                        <div class="kyc-status-pill" onclick="setStatusFilter('NotSubmitted', this)">Not submitted</div>
                    </div>

                    <div class="vsl-table-wrap">
                        <table class="vsl-table" style="width:100%; border-collapse:collapse;">
                            <thead>
                                <tr style="background:#f8fafc; text-align:left; border-top: 1px solid #e2e8f0;">
                                    <th
                                        style="padding:12px; font-size:0.7rem; color:#1e293b; border-bottom:1px solid #e2e8f0;">
                                        Customer (username)</th>
                                    <th
                                        style="padding:12px; font-size:0.7rem; color:#1e293b; border-bottom:1px solid #e2e8f0;">
                                        state</th>
                                    <th
                                        style="padding:12px; font-size:0.7rem; color:#1e293b; border-bottom:1px solid #e2e8f0;">
                                        Verify mobile phone number</th>
                                    <th
                                        style="padding:12px; font-size:0.7rem; color:#1e293b; border-bottom:1px solid #e2e8f0;">
                                        Email</th>
                                    <th
                                        style="padding:12px; font-size:0.7rem; color:#1e293b; border-bottom:1px solid #e2e8f0;">
                                        Full name</th>
                                    <th
                                        style="padding:12px; font-size:0.7rem; color:#1e293b; border-bottom:1px solid #e2e8f0;">
                                        Gender</th>
                                    <th
                                        style="padding:12px; font-size:0.7rem; color:#1e293b; border-bottom:1px solid #e2e8f0;">
                                        Date of Birth</th>
                                    <th
                                        style="padding:12px; font-size:0.7rem; color:#1e293b; border-bottom:1px solid #e2e8f0;">
                                        ID number</th>
                                    <th
                                        style="padding:12px; font-size:0.7rem; color:#1e293b; border-bottom:1px solid #e2e8f0;">
                                        ID photo (front view)</th>
                                    <th
                                        style="padding:12px; font-size:0.7rem; color:#1e293b; border-bottom:1px solid #e2e8f0;">
                                        ID photo (back)</th>
                                    <th
                                        style="padding:12px; font-size:0.7rem; color:#1e293b; border-bottom:1px solid #e2e8f0;">
                                        salesperson</th>
                                    <th
                                        style="padding:12px; font-size:0.7rem; color:#1e293b; border-bottom:1px solid #e2e8f0;">
                                        Application time</th>
                                    <th
                                        style="padding:12px; font-size:0.7rem; color:#1e293b; border-bottom:1px solid #e2e8f0;">
                                        information</th>
                                    <th
                                        style="padding:12px; font-size:0.7rem; color:#1e293b; border-bottom:1px solid #e2e8f0;">
                                        operate</th>
                                </tr>
                            </thead>
                            <tbody id="kycList"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="pageUsers" class="vsl-page" style="display:none;">
                <div class="section-card">
                    <h3>Customer Management</h3>
                    <div class="vsl-table-wrap">
                        <table class="vsl-table" style="width:100%; border-collapse:collapse;">
                            <thead>
                                <tr style="background:#f8fafc; text-align:left;">
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Client</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Name</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Balance</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        VIP</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Credit</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        PIN</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Operate</th>
                                </tr>
                            </thead>
                            <tbody id="userList"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="pageDeposits" class="vsl-page" style="display:none;">
                <div class="section-card">
                    <h3>Deposit records</h3>
                    <div class="vsl-table-wrap">
                        <table class="vsl-table" style="width:100%; border-collapse:collapse;">
                            <thead>
                                <tr style="background:#f8fafc; text-align:left;">
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        ID</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        User</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Amount</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Status</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Time</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Operate</th>
                                </tr>
                            </thead>
                            <tbody id="depList"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="pageWithdrawals" class="vsl-page" style="display:none;">
                <div class="section-card">
                    <h3>Withdrawal records</h3>
                    <div class="vsl-table-wrap">
                        <table class="vsl-table" style="width:100%; border-collapse:collapse;">
                            <thead>
                                <tr style="background:#f8fafc; text-align:left;">
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        User ID</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Username</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Amount</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Bank Account</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Status</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Date Submitted</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Operate</th>
                                </tr>
                            </thead>
                            <tbody id="withList"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Page: Loans -->
            <div id="pageLoans" class="vsl-page" style="display:none;">
                <div class="section-card">
                    <h3>Loan records</h3>
                    <div class="vsl-table-wrap">
                        <table class="vsl-table" style="width:100%; border-collapse:collapse;">
                            <thead>
                                <tr style="background:#f8fafc; text-align:left;">
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        ID</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        User</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Loan Amount</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Status</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Time</th>
                                </tr>
                            </thead>
                            <tbody id="loanList">
                                <tr>
                                    <td colspan="5" style="text-align:center; padding:20px; color:#94a3b8;">No records
                                        found.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Page: Rewards -->
            <div id="pageRewards" class="vsl-page" style="display:none;">
                <div class="section-card">
                    <h3>Bonus Points Record</h3>
                    <div class="vsl-table-wrap">
                        <table class="vsl-table" style="width:100%; border-collapse:collapse;">
                            <thead>
                                <tr style="background:#f8fafc; text-align:left;">
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        User</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Points</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Type</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Time</th>
                                </tr>
                            </thead>
                            <tbody id="rewardList">
                                <tr>
                                    <td colspan="4" style="text-align:center; padding:20px; color:#94a3b8;">No records
                                        found.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Page: Stock -->
            <div id="pageStock" class="vsl-page" style="display:none;">
                <div class="section-card">
                    <h3>Stock trading</h3>
                    <div class="vsl-table-wrap">
                        <table class="vsl-table" style="width:100%; border-collapse:collapse;">
                            <thead>
                                <tr style="background:#f8fafc; text-align:left;">
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Symbol</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        User</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Side</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Qty</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Price</th>
                                </tr>
                            </thead>
                            <tbody id="stockList">
                                <tr>
                                    <td colspan="5" style="text-align:center; padding:20px; color:#94a3b8;">No records
                                        found.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Page: Bulk -->
            <div id="pageBulk" class="vsl-page" style="display:none;">
                <div class="section-card">
                    <h3>Large transactions</h3>
                    <div class="vsl-table-wrap">
                        <table class="vsl-table" style="width:100%; border-collapse:collapse;">
                            <thead>
                                <tr style="background:#f8fafc; text-align:left;">
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Asset</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Volume</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        User</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Time</th>
                                </tr>
                            </thead>
                            <tbody id="bulkList">
                                <tr>
                                    <td colspan="4" style="text-align:center; padding:20px; color:#94a3b8;">No records
                                        found.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Page: IPO -->
            <div id="pageIpo" class="vsl-page" style="display:none;">
                <div class="section-card">
                    <h3>IPO</h3>
                    <div class="vsl-table-wrap">
                        <table class="vsl-table" style="width:100%; border-collapse:collapse;">
                            <thead>
                                <tr style="background:#f8fafc; text-align:left;">
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        IPO Name</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        User</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Status</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Date</th>
                                </tr>
                            </thead>
                            <tbody id="ipoList">
                                <tr>
                                    <td colspan="4" style="text-align:center; padding:20px; color:#94a3b8;">No records
                                        found.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Page: Fund -->
            <div id="pageFund" class="vsl-page" style="display:none;">
                <div class="section-card">
                    <h3>Fund trading</h3>
                    <div class="vsl-table-wrap">
                        <table class="vsl-table" style="width:100%; border-collapse:collapse;">
                            <thead>
                                <tr style="background:#f8fafc; text-align:left;">
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Fund Name</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        User</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Amount</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Time</th>
                                </tr>
                            </thead>
                            <tbody id="fundList">
                                <tr>
                                    <td colspan="4" style="text-align:center; padding:20px; color:#94a3b8;">No records
                                        found.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Page: Quant -->
            <!-- Product Management Page -->
            <div id="pageProducts" class="vsl-page" style="display:none;">
                <div class="vsl-header">
                    <h2 class="vsl-title">Product Management</h2>
                    <button class="vsl-btn-primary" onclick="openAddProductModal()">+ Add Product</button>
                </div>
                <div class="section-card">
                    <div class="vsl-table-wrap">
                        <table class="vsl-table">
                            <thead>
                                <tr>
                                    <th>Product Name</th>
                                    <th>Estimated Profit</th>
                                    <th>Listing Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="productList">
                                <!-- Mock Data -->
                                <tr>
                                    <td>Hyundai India IPO</td>
                                    <td>300%</td>
                                    <td>2026-03-15</td>
                                    <td><span class="vsl-badge approved">Selling</span></td>
                                    <td><button class="vsl-btn-small"
                                            onclick="alert('Edit logic to be implemented')">Edit</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Institutional Stock 057 -->
            <div id="pageStock057" class="vsl-page" style="display:none;">
                <div class="vsl-header">
                    <h2 class="vsl-title">Institutional Stock 057</h2>
                </div>
                <div class="section-card">
                    <p>Institutional terminal configuration and stock list.</p>
                </div>
            </div>

            <div id="pageQuant" class="vsl-page" style="display:none;">
                <div class="section-card">
                    <h3>Quantitative Trading</h3>
                    <div class="vsl-table-wrap">
                        <table class="vsl-table" style="width:100%; border-collapse:collapse;">
                            <thead>
                                <tr style="background:#f8fafc; text-align:left;">
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Strategy</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Profit</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        User</th>
                                    <th
                                        style="padding:12px; font-size:0.75rem; color:#64748b; border-bottom:2px solid #e2e8f0;">
                                        Time</th>
                                </tr>
                            </thead>
                            <tbody id="quantList">
                                <tr>
                                    <td colspan="4" style="text-align:center; padding:20px; color:#94a3b8;">No records
                                        found.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- EDIT KYC MODAL -->
    <div id="editKycModal" class="kyc-modal-overlay">
        <div class="kyc-modal-card">
            <div class="kyc-modal-header">
                <span>Edit KYC</span>
                <i data-lucide="x" style="cursor:pointer" onclick="closeEditKyc()"></i>
            </div>
            <div class="kyc-modal-body">
                <div class="kyc-grid">
                    <div class="kyc-form-group">
                        <label>Username <span style="color:#ef4444">*</span></label>
                        <input type="text" id="ek_name" class="kyc-input" placeholder="Enter username">
                    </div>
                    <div class="kyc-form-group">
                        <label>Full Name <span style="color:#ef4444">*</span></label>
                        <input type="text" id="ek_fullname" class="kyc-input" placeholder="Enter full name">
                    </div>
                    <div class="kyc-form-group">
                        <label>ID Card <span style="color:#ef4444">*</span></label>
                        <input type="text" id="ek_idnum" class="kyc-input" placeholder="Enter ID number">
                    </div>
                    <div class="kyc-form-group">
                        <label>phone number <span style="color:#ef4444">*</span></label>
                        <input type="text" id="ek_phone" class="kyc-input" placeholder="Enter phone">
                    </div>
                    <div class="kyc-form-group">
                        <label>Email <span style="color:#ef4444">*</span></label>
                        <input type="text" id="ek_email" class="kyc-input" placeholder="Enter email">
                    </div>
                    <div class="kyc-form-group">
                        <label>Date of birth <span style="color:#ef4444">*</span></label>
                        <input type="text" id="ek_dob" class="kyc-input" placeholder="Enter DOB (YYYY-MM-DD)">
                    </div>
                    <div class="kyc-form-group">
                        <label>Gender <span style="color:#ef4444">*</span></label>
                        <select id="ek_gender" class="kyc-input">
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="kyc-form-group" style="margin-bottom:20px;">
                    <label>Withdrawal PIN <span style="color:#94a3b8; font-weight:400; font-size:0.75rem;">(Edit to
                            reset user PIN)</span></label>
                    <input type="text" id="ek_pin" class="kyc-input" placeholder="User PIN (e.g. 123456)">
                </div>

                <div class="kyc-image-grid">
                    <div>
                        <label
                            style="display:block; margin-bottom:8px; font-weight:500; font-size:0.8rem; color:#64748b;">Front
                            of the document</label>
                        <div class="kyc-img-box" onclick="document.getElementById('ek_front_file').click()">
                            <i data-lucide="plus" class="kyc-plus-icon" id="ek_front_plus"></i>
                            <img id="ek_front_img" src="" alt="Front Image">
                            <i data-lucide="x" class="kyc-img-remove"
                                onclick="event.stopPropagation(); removeKycImg('front')"></i>
                            <input type="file" id="ek_front_file" hidden accept="image/*"
                                onchange="uploadKycFile(this, 'front')">
                        </div>
                        <p class="kyc-img-hint">Supported formats: JPG, PNG, WEBP, GIF, BMP, SVG, ICO, HEIC. Maximum of
                            1 image.</p>
                    </div>
                    <div>
                        <label
                            style="display:block; margin-bottom:8px; font-weight:500; font-size:0.8rem; color:#64748b;">Back
                            of the document</label>
                        <div class="kyc-img-box" onclick="document.getElementById('ek_back_file').click()">
                            <i data-lucide="plus" class="kyc-plus-icon" id="ek_back_plus"></i>
                            <img id="ek_back_img" src="" alt="Back Image">
                            <i data-lucide="x" class="kyc-img-remove"
                                onclick="event.stopPropagation(); removeKycImg('back')"></i>
                            <input type="file" id="ek_back_file" hidden accept="image/*"
                                onchange="uploadKycFile(this, 'back')">
                        </div>
                        <p class="kyc-img-hint">Supported formats: JPG, PNG, WEBP, GIF, BMP, SVG, ICO, HEIC. Maximum of
                            1 image.</p>
                    </div>
                </div>

                <div class="kyc-form-group" style="margin-top:20px;">
                    <label>Authentication status <span style="color:#ef4444">*</span></label>
                    <select id="ek_status" class="kyc-input">
                        <option value="Pending">å¾…å®¡æ ¸ (Pending)</option>
                        <option value="Approved">Approved</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                </div>

                <div class="kyc-form-group">
                    <label>Notes (visible to customer)</label>
                    <textarea id="ek_notes" class="kyc-input" rows="3" placeholder="Please enter a note."></textarea>
                </div>

                <div class="kyc-status-warning">
                    Editing customer's real-name information: Authentication status cannot be modified.
                </div>
            </div>
            <div class="kyc-modal-footer">
                <button class="vsl-btn submit" id="ek_save_btn" onclick="saveEditKyc()">submit</button>
                <button class="vsl-btn cancel" onclick="closeEditKyc()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- NEW MESSAGE MODAL -->
    <div id="msgModal" class="loader" style="background:rgba(0,0,0,0.5); z-index:2000;">
        <div class="section-card" style="width:550px; min-height:auto;">
            <h3>Create New Notification</h3>
            <select id="msgTarget"
                style="width:100%; padding:12px; margin-bottom:15px; border-radius:8px; border:1px solid #ddd;"></select>
            <input id="msgTitle" placeholder="Enter message title"
                style="width:100%; padding:12px; margin-bottom:15px; border-radius:8px; border:1px solid #ddd;">
            <textarea id="msgBody" rows="8" placeholder="Enter message content..."
                style="width:100%; padding:12px; border-radius:8px; border:1px solid #ddd;"></textarea>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                <button class="vsl-btn"
                    onclick="document.getElementById('msgModal').style.display='none'">Cancel</button>
                <button class="vsl-btn green" onclick="sendMsg()">Confirm Send</button>
            </div>
        </div>
    </div>

    <!-- MANUAL BALANCE MODAL -->
    <div id="depositModal" class="kyc-modal-overlay">
        <div class="kyc-modal-card" style="height:auto; max-width: 400px;">
            <div class="kyc-modal-header">
                <span>Manage Balance</span>
                <i data-lucide="x" style="cursor:pointer" onclick="closeDepositModal()"></i>
            </div>
            <div class="kyc-modal-body">
                <input type="hidden" id="dep_user_id">
                <input type="hidden" id="dep_id">
                <div class="kyc-form-group">
                    <label>User</label>
                    <input type="text" id="dep_username" class="kyc-input" readonly
                        style="background: #f1f5f9; color: #64748b;">
                </div>
                <div class="kyc-form-group">
                    <label>Transaction Type</label>
                    <select id="dep_type" class="kyc-input">
                        <option value="deposit">Deposit (Add Money)</option>
                        <option value="set">Set Balance (Edit/Correct)</option>
                    </select>
                </div>
                <div class="kyc-form-group">
                    <label>Amount (â‚¹) <span style="color:#ef4444">*</span></label>
                    <input type="number" id="dep_amount" class="kyc-input" placeholder="Enter amount">
                </div>
                <!-- Added Status Field -->
                <div class="kyc-form-group">
                    <label>Status <span style="color:#ef4444">*</span></label>
                    <select id="dep_status" class="kyc-input">
                        <option value="Approved">Approved</option>
                        <option value="Pending">Pending</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                </div>
                <div class="kyc-form-group">
                    <label>Note (Optional)</label>
                    <textarea id="dep_note" class="kyc-input" rows="2" placeholder="Reason for transaction"></textarea>
                </div>
            </div>
            <div class="kyc-modal-footer">
                <button class="vsl-btn submit" style="width: 100%;" onclick="submitDeposit()">Confirm
                    Transaction</button>
            </div>
        </div>
    </div>

    <!-- MANUAL WITHDRAWAL MODAL -->
    <div id="withdrawalModal" class="kyc-modal-overlay">
        <div class="kyc-modal-card" style="height:auto; max-width: 400px;">
            <div class="kyc-modal-header">
                <span>Manage Withdrawal</span>
                <i data-lucide="x" style="cursor:pointer" onclick="closeWithdrawalModal()"></i>
            </div>
            <div class="kyc-modal-body">
                <input type="hidden" id="wd_id">
                <div class="kyc-form-group">
                    <label>User</label>
                    <input type="text" id="wd_username" class="kyc-input" readonly
                        style="background: #f1f5f9; color: #64748b;">
                </div>
                <div class="kyc-form-group">
                    <label>Amount (â‚¹)</label>
                    <input type="number" id="wd_amount" class="kyc-input" readonly
                        style="background: #f1f5f9; color: #64748b;">
                </div>
                <div class="kyc-form-group">
                    <label>Status <span style="color:#ef4444">*</span></label>
                    <select id="wd_status" class="kyc-input">
                        <option value="Pending">Pending</option>
                        <option value="Approved">Approved</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                </div>
                <div class="kyc-form-group">
                    <label>Note (Optional)</label>
                    <textarea id="wd_note" class="kyc-input" rows="2" placeholder="Reason for decision"></textarea>
                </div>
            </div>
            <div class="kyc-modal-footer">
                <button class="vsl-btn submit" style="width: 100%;" onclick="submitWithdrawalEdit()">Update
                    Status</button>
            </div>
        </div>
    </div>

    <script>
        const adminSession = sessionStorage.getItem('admin_auth');
        if (!adminSession) {
            window.location.href = 'admin_login.html';
        } else {
            try {
                const adminData = JSON.parse(adminSession);
                if (!adminData || !adminData.id) window.location.href = 'admin_login.html';
            } catch (e) {
                window.location.href = 'admin_login.html';
            }
        }
        lucide.createIcons();

        const PAGE_NAMES = {
            'home': 'front page', 'kyc': 'Real-name authentication', 'users': 'Customer Management',
            'deposits': 'Deposit records', 'withdrawals': 'Withdrawal Requests', 'loans': 'Loan records',
            'rewards': 'Bonus Points Record', 'stock': 'Stock trading', 'bulk': 'Large transactions',
            'ipo': 'IPO', 'fund': 'Fund trading', 'quant': 'Quantitative Trading', 'messages': 'Notification Center',
            'livechat': 'Customer Service Support', 'products': 'Product Management', 'stock057': 'Institutional Stock 057'
        };
        let openTabs = ['home'];
        let allUsers = [];
        let allMsgs = [];
        let allSubmissions = [];
        let kycStatusFilter = 'all';



        async function init() {
            showLoader(true);
            try {
                const client = DB.getClient();
                if (!client) throw new Error("Database client not initialized");

                // Helper for safe, limited fetching
                const fetchSafe = async (table, select = '*', limit = 200) => {
                    try {
                        const { data, error } = await client.from(table)
                            .select(select)
                            .order('created_at', { ascending: false })
                            .limit(limit);
                        return error ? [] : data;
                    } catch (e) { return []; }
                };

                // 1. FAST TRACK: Fetch only what's needed for the dashboard stats first
                // This allows the admin to see 'something' immediately.
                const [userRes, tradeRes, kycRes] = await Promise.all([
                    client.from('users').select('id, kyc', { count: 'exact', head: false }),
                    client.from('trades').select('id, status', { count: 'exact', head: false }).eq('status', 'Pending'),
                    client.from('kyc_submissions').select('id', { count: 'exact', head: false })
                ]);

                const allU = userRes.data || [];
                const pendingTradesCount = tradeRes.data?.length || 0;

                const pendingKycCount = allU.filter(u => {
                    const sub = (u.kyc_submissions && u.kyc_submissions.length > 0) ? u.kyc_submissions[0] : null;
                    return sub && sub.status === 'Pending';
                }).length;

                // Render Dashboard Stats Immediately
                document.getElementById('stat_summary').innerHTML = `
                    <div class="section-card" style="background:#f0f9ff; margin:0; flex:1;">
                        <div style="font-size:0.75rem;">TOTAL USERS</div>
                        <h2 style="margin:5px 0 0 0;">${allU.length}</h2>
                    </div>
                    <div class="section-card" style="background:#f0fdf4; margin:0; flex:1;">
                        <div style="font-size:0.75rem;">PENDING KYC</div>
                        <h2 style="margin:5px 0 0 0;">${pendingKycCount}</h2>
                    </div>
                    <div class="section-card" style="background:#fff7ed; margin:0; flex:1;">
                        <div style="font-size:0.75rem;">PENDING TRADES</div>
                        <h2 style="margin:5px 0 0 0;">${pendingTradesCount}</h2>
                    </div>
                `;

                // 2. PROGRESSIVE LOADING: Fetch the heavy lists individually or in smaller batches
                // Use a smaller limit to prevent 10-minute hang. 200 is plenty for an admin overview.

                // Load Users (Full details for list) with JOINED LATEST KYC record
                client.from('users')
                    .select('*, kyc_submissions(*)')
                    .order('created_at', { ascending: false })
                    .order('submitted_at', { foreignTable: 'kyc_submissions', ascending: false })
                    .limit(500)
                    .then(({ data }) => {
                        allUsers = data || [];
                        // Ensure each user has only the latest sub in their array if multiple exist (extra safety)
                        allUsers.forEach(u => {
                            if (u.kyc_submissions && u.kyc_submissions.length > 1) {
                                u.kyc_submissions.sort((a, b) => new Date(b.submitted_at || b.created_at) - new Date(a.submitted_at || a.created_at));
                                u.kyc_submissions = [u.kyc_submissions[0]];
                            }
                        });
                        // Update userList table
                        document.getElementById('userList').innerHTML = allUsers.length ? allUsers.map(x => `
                        <tr>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9;">${x.mobile || '-'}</td>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9;">${x.username || '-'}</td>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9;">â‚¹${parseFloat(x.balance || 0).toFixed(2)}</td>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9;">${x.vip || 0}</td>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9;">${x.credit_score || 100}</td>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9;">${x.withdrawal_pin || '<span style="color:#cbd5e1">-</span>'}</td>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9;">
                                <div class="btn-edit-wrap">
                                    <i data-lucide="edit" size="16" style="cursor:pointer" onclick="openKycEdit('${x.id}')"></i>
                                    <i data-lucide="indian-rupee" size="16" style="cursor:pointer; color:#10b981;" onclick="openDepositModal('${x.id}', '${x.username || 'User'}')"></i>
                                </div>
                            </td>
                        </tr>
                    `).join('') : '<tr><td colspan="7" style="text-align:center; padding:20px;">No users found</td></tr>';
                        lucide.createIcons();

                        // Also render the KYC list using the same data
                        renderKycList();
                    });

                // Load Withdrawals/Deposits
                fetchSafe('withdrawals', '*, users(id,mobile,username)', 100).then(data => {
                    const list = document.getElementById('withList');
                    if (!list) return;
                    list.innerHTML = data.length ? data.map(x => {
                        const statusColors = {
                            'Approved': 'background:#dcfce7; color:#166534;',
                            'Rejected': 'background:#fee2e2; color:#991b1b;',
                            'Pending': 'background:#fef3c7; color:#92400e;'
                        };
                        const rawStatus = x.status || 'Pending';
                        const displayStatus = rawStatus.toUpperCase();
                        const sStyle = statusColors[rawStatus] || statusColors[displayStatus.charAt(0) + displayStatus.slice(1).toLowerCase()] || 'background:#f1f5f9; color:#64748b;';
                        const uName = x.users?.username || x.users?.mobile || 'User';
                        return `
                        <tr>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9;">#${x.user_id}</td>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9;">${uName}</td>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9; font-weight:700;">â‚¹${parseFloat(x.amount).toLocaleString('en-IN', { minimumFractionDigits: 2 })}</td>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9;">
                                <div style="font-size:0.8rem; font-weight:600;">${x.bank_name || '-'}</div>
                                <div style="font-size:0.7rem; color:#64748b;">${x.account_number || ''}</div>
                            </td>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9;"><span style="padding:3px 8px; border-radius:4px; font-weight:700; font-size:0.7rem; text-transform:uppercase; ${sStyle}">${displayStatus}</span></td>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9; font-size:0.75rem; color:#64748b;">${new Date(x.created_at).toLocaleString('en-IN')}</td>
                             <td style="padding:12px; border-bottom:1px solid #f1f5f9;">
                                <div style="display:flex; gap:8px;">
                                    ${displayStatus === 'PENDING' ? `
                                        <button class="vsl-btn green" onclick="quickActionWithdraw(${x.id}, 'Approved')" style="padding:4px 8px; font-size:0.65rem;">Approve</button>
                                        <button class="vsl-btn" onclick="quickActionWithdraw(${x.id}, 'Rejected')" style="padding:4px 8px; font-size:0.65rem; background:#fee2e2; color:#991b1b; border:none;">Reject</button>
                                    ` : `
                                        <div class="btn-edit-wrap"><i data-lucide="edit" size="16" style="cursor:pointer" onclick="openWithdrawalEdit(${x.id}, '${uName}', ${x.amount}, '${rawStatus}', '${x.admin_note || ''}')"></i></div>
                                    `}
                                </div>
                            </td>
                        </tr>
                    `;
                    }).join('') : '<tr><td colspan="7" style="text-align:center; padding:20px;">No withdrawals found</td></tr>';
                    lucide.createIcons();
                });

                fetchSafe('deposits', '*, users(mobile,username)', 100).then(data => {
                    const list = document.getElementById('depList');
                    if (!list) return;
                    list.innerHTML = data.length ? data.map(x => `
                        <tr>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9;">#${x.id}</td>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9;">${x.users?.mobile || 'Unknown'}</td>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9;">
                                â‚¹${parseFloat(x.amount).toFixed(2)}
                                ${x.image_url ? `<br><a href="${x.image_url}" target="_blank" style="font-size:0.65rem; color:#3b82f6;">View Screenshot</a>` : ''}
                            </td>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9;"><span style="padding:3px 8px; border-radius:4px; font-weight:700; font-size:0.7rem; background:#fef3c7; color:#92400e;">${x.status}</span></td>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9;">${new Date(x.created_at).toLocaleString()}</td>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9;">
                                <div class="btn-edit-wrap"><i data-lucide="edit" size="16" style="cursor:pointer" onclick="openDepositEdit(${x.id}, '${x.users?.mobile || 'User'}', ${x.amount}, '${x.status}', '${x.admin_note || ''}')"></i></div>
                            </td>
                        </tr>
                    `).join('') : '<tr><td colspan="6" style="text-align:center; padding:20px;">No deposits found</td></tr>';
                    lucide.createIcons();
                });

                // Load Messages for Notification Center
                fetchSafe('messages', '*, users(mobile)', 100).then(data => {
                    // Filter internal messages like before
                    const filtered = data.filter(x => x.sender === 'Admin' || x.sender === 'System');
                    allMsgs = filtered;
                    renderMessages(filtered);
                });

                // Load Trades
                fetchSafe('trades', '*, users(mobile,username)', 300).then(data => {
                    const stocks = data.filter(t => t.type === 'stock' || t.type === 'otc');
                    const ipos = data.filter(t => t.type === 'ipo');

                    if (stocks) {
                        const stockTbody = document.getElementById('stockList');
                        if (stockTbody) {
                            stockTbody.innerHTML = stocks.length ? stocks.map(t => `
                                <tr>
                                    <td style="padding:12px; border-bottom:1px solid #f1f5f9;">
                                        <div style="font-weight:700;">${t.symbol}</div>
                                        <div style="font-size:0.75rem; color:#64748b;">${t.name}</div>
                                    </td>
                                    <td style="padding:12px; border-bottom:1px solid #f1f5f9;">${t.users?.mobile || 'Unknown'}</td>
                                    <td style="padding:12px; border-bottom:1px solid #f1f5f9; text-transform:uppercase; font-size:0.75rem; font-weight:700; color:${t.type === 'stock' ? '#3b82f6' : '#8b5cf6'}">${t.type}</td>
                                    <td style="padding:12px; border-bottom:1px solid #f1f5f9;">
                                        <div>Qty: ${t.quantity}</div>
                                        <div>Price: â‚¹${t.price}</div>
                                    </td>
                                    <td style="padding:12px; border-bottom:1px solid #f1f5f9;">
                                        <span style="padding:3px 8px; border-radius:4px; font-weight:700; font-size:0.7rem; background:${t.status === 'Pending' ? '#fef3c7' : t.status === 'Settled' ? '#dcfce7' : '#fee2e2'}; color:${t.status === 'Pending' ? '#92400e' : t.status === 'Settled' ? '#166534' : '#991b1b'};">${t.status}</span>
                                        ${t.image_url ? `<div style="margin-top:4px;"><a href="${t.image_url}" target="_blank" style="font-size:0.65rem; color:#3b82f6;">Payment Proof</a></div>` : ''}
                                    </td>
                                    <td style="padding:12px; border-bottom:1px solid #f1f5f9;">
                                        ${t.status === 'Pending' ? `
                                            <button class="vsl-btn green" onclick="updateTradeStatus(${t.id}, 'Settled')" style="padding:4px 8px; font-size:0.7rem;">Approve</button>
                                            <button class="vsl-btn" onclick="updateTradeStatus(${t.id}, 'Rejected')" style="padding:4px 8px; font-size:0.7rem; background:#fee2e2; color:#991b1b; border:none;">Reject</button>
                                        ` : '-'}
                                    </td>
                                </tr>
                            `).join('') : '<tr><td colspan="6" style="padding:20px; text-align:center; color:#94a3b8;">No stock/OTC trades found</td></tr>';
                        }
                    }

                    if (ipos) {
                        const ipoTbody = document.getElementById('ipoList');
                        if (ipoTbody) {
                            ipoTbody.innerHTML = ipos.length ? ipos.map(t => `
                                <tr>
                                    <td style="padding:12px; border-bottom:1px solid #f1f5f9;">
                                        <div style="font-weight:700;">${t.name}</div>
                                        <div style="font-size:0.75rem; color:#64748b;">${t.symbol}</div>
                                    </td>
                                    <td style="padding:12px; border-bottom:1px solid #f1f5f9;">${t.users?.mobile || 'Unknown'}</td>
                                    <td style="padding:12px; border-bottom:1px solid #f1f5f9;">
                                        <span style="padding:3px 8px; border-radius:4px; font-weight:700; font-size:0.7rem; background:${t.status === 'Pending' ? '#fef3c7' : t.status === 'Settled' ? '#dcfce7' : '#fee2e2'}; color:${t.status === 'Pending' ? '#92400e' : t.status === 'Settled' ? '#166534' : '#991b1b'};">${t.status}</span>
                                        ${t.image_url ? `<div style="margin-top:4px;"><a href="${t.image_url}" target="_blank" style="font-size:0.65rem; color:#3b82f6;">Payment Proof</a></div>` : ''}
                                    </td>
                                    <td style="padding:12px; border-bottom:1px solid #f1f5f9;">${new Date(t.created_at).toLocaleDateString()}</td>
                                    <td style="padding:12px; border-bottom:1px solid #f1f5f9;">
                                        ${t.status === 'Pending' ? `
                                            <button class="vsl-btn green" onclick="updateTradeStatus(${t.id}, 'Settled')" style="padding:4px 8px; font-size:0.7rem;">Approve</button>
                                            <button class="vsl-btn" onclick="updateTradeStatus(${t.id}, 'Rejected')" style="padding:4px 8px; font-size:0.7rem; background:#fee2e2; color:#991b1b; border:none;">Reject</button>
                                        ` : '-'}
                                    </td>
                                </tr>
                            `).join('') : '<tr><td colspan="5" style="padding:20px; text-align:center; color:#94a3b8;">No IPO requests found</td></tr>';
                        }
                    }
                    lucide.createIcons();
                });

                // Background Listener for Chat (Initialize early)
                initLiveChat();

                // Load and Render Products
                renderProducts();

                // Load Loans
                fetchSafe('loans', '*, users(mobile,username)', 100).then(data => {
                    const list = document.getElementById('loanList');
                    if (!list) return;
                    list.innerHTML = data.length ? data.map(x => {
                        const rawStatus = x.status || 'Pending';
                        let sStyle = 'background:#f1f5f9; color:#64748b;';
                        if (rawStatus === 'Approved') sStyle = 'background:#dcfce7; color:#166534;';
                        else if (rawStatus === 'Rejected') sStyle = 'background:#fee2e2; color:#991b1b;';
                        else if (rawStatus === 'Pending') sStyle = 'background:#fef3c7; color:#92400e;';

                        const uName = x.users?.username || x.users?.mobile || 'User';
                        const displayStatus = rawStatus; // Already Title Case

                        return `
                        <tr>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9; font-size:0.75rem;">#${x.id}</td>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9; font-size:0.75rem;">${uName}</td>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9; font-weight:700; font-size:0.8rem;">
                                â‚¹${parseFloat(x.amount).toLocaleString('en-IN')}
                                <div style="font-size:0.65rem; font-weight:400; color:#64748b; margin-top:2px;">${x.purpose || 'No purpose'}</div>
                            </td>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9;"><span style="padding:3px 8px; border-radius:4px; font-weight:700; font-size:0.7rem; text-transform:uppercase; ${sStyle}">${displayStatus}</span></td>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9; font-size:0.75rem; color:#64748b;">${new Date(x.created_at).toLocaleString()}</td>
                             <td style="padding:12px; border-bottom:1px solid #f1f5f9;">
                                ${rawStatus === 'Pending' ? `
                                    <button class="vsl-btn green" onclick="quickActionLoan(${x.id}, 'Approved')" style="padding:4px 8px; font-size:0.65rem;">Approve</button>
                                    <button class="vsl-btn" onclick="quickActionLoan(${x.id}, 'Rejected')" style="padding:4px 8px; font-size:0.65rem; background:#fee2e2; color:#991b1b; border:none;">Reject</button>
                                ` : `
                                    <span style="font-size:0.7rem; color:#94a3b8;">${x.admin_note || '-'}</span>
                                `}
                            </td>
                        </tr>
                        `;
                    }).join('') : '<tr><td colspan="6" style="text-align:center; padding:20px; color:#94a3b8;">No loan records found</td></tr>';
                    lucide.createIcons();
                });

            } catch (error) {
                console.error("Dashboard Init Error:", error);
                alert("Error loading dashboard data: " + error.message);
            } finally {
                // Done with main initialization, but promises might still be resolving
                showLoader(false);
            }
        }




        function setStatusFilter(s, el) {
            document.querySelectorAll('.kyc-status-pill').forEach(x => x.classList.remove('active'));
            el.classList.add('active');
            kycStatusFilter = s;
            renderKycList();
        }

        function filterKyc() {
            renderKycList();
        }

        function renderKycList() {
            const list = document.getElementById('kycList');
            if (!list) return;

            const fu = document.getElementById('kf_user')?.value.toLowerCase();
            const fn = document.getElementById('kf_name')?.value.toLowerCase();
            const fp = document.getElementById('kf_phone')?.value.toLowerCase();

            let data = allUsers.filter(u => {
                // Status Filter
                const sub = (u.kyc_submissions && u.kyc_submissions.length > 0) ? u.kyc_submissions[0] : null;
                const effectiveStatus = sub ? sub.status : 'NotSubmitted';

                if (kycStatusFilter !== 'all') {
                    if (kycStatusFilter === 'NotSubmitted' && sub) return false;
                    if (kycStatusFilter !== 'NotSubmitted' && effectiveStatus !== kycStatusFilter) return false;
                }
                // String Search Filters
                if (fu && !(u.username || '').toLowerCase().includes(fu)) return false;
                if (fn && !(u.full_name || '').toLowerCase().includes(fn)) return false;
                if (fp && !u.mobile.toLowerCase().includes(fp)) return false;
                return true;
            });

            list.innerHTML = data.map(x => {
                const sub = (x.kyc_submissions && x.kyc_submissions.length > 0) ? x.kyc_submissions[0] : null;

                // Status logic: Prefer sub.status, fallback to 'Not Submitted'
                const effectiveStatus = sub ? sub.status : 'NotSubmitted';
                const statusClass = effectiveStatus === 'Approved' ? 'approved' : (effectiveStatus === 'Rejected' ? 'reject' : (effectiveStatus === 'Pending' ? 'pending' : 'not-submitted'));
                const statusText = effectiveStatus === 'Pending' ? 'å¾…å®¡æ ¸' : (effectiveStatus === 'NotSubmitted' ? 'Not Submitted' : effectiveStatus);

                return `
                        <tr>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9; font-size:0.75rem;">${x.username || '-'}</td>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9;"><span class="kyc-badge ${statusClass}">${statusText}</span></td>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9; font-size:0.75rem;">${x.mobile || '-'}</td>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9; font-size:0.75rem;">${x.email || '-'}</td>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9; font-size:0.75rem;">${x.full_name || '-'}</td>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9; font-size:0.75rem;">${x.gender || '-'}</td>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9; font-size:0.75rem;">${x.dob || '-'}</td>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9; font-size:0.75rem;">${x.id_number || '-'}</td>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9;">
                                ${sub?.id_front_url ? `<img src="${sub.id_front_url}" class="kyc-table-img" onclick="openKycEdit('${x.id}')">` : `<div class="kyc-table-img" style="display:flex;align-items:center;justify-content:center; opacity:0.3;"><i data-lucide="image" size="14"></i></div>`}
                            </td>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9;">
                                ${sub?.id_back_url ? `<img src="${sub.id_back_url}" class="kyc-table-img" onclick="openKycEdit('${x.id}')">` : `<div class="kyc-table-img" style="display:flex;align-items:center;justify-content:center; opacity:0.3;"><i data-lucide="image" size="14"></i></div>`}
                            </td>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9; font-size:0.75rem;">-</td>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9; font-size:0.75rem;">${sub?.submitted_at ? new Date(sub.submitted_at).toLocaleString() : '-'}</td>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9; font-size:0.75rem;">-</td>
                            <td style="padding:12px; border-bottom:1px solid #f1f5f9;">
                                <div class="btn-edit-wrap">
                                    <i data-lucide="edit" size="16" style="cursor:pointer" onclick="openKycEdit('${x.id}')"></i>
                                </div>
                            </td>
                        </tr>
                    `;
            }).join('');
            lucide.createIcons();
        }


        function renderMessages(msgs) {
            const list = document.getElementById('sentMsgs');
            if (!msgs.length) { list.innerHTML = '<p style="text-align:center; padding:40px; color:#94a3b8;">No records found.</p>'; return; }

            // Filter: ONLY internal messages (JSON notifications)
            const filtered = msgs.filter(x => {
                try {
                    const p = JSON.parse(x.message);
                    return p.title !== undefined;
                } catch (e) { return false; }
            });

            if (!filtered.length) { list.innerHTML = '<p style="text-align:center; padding:40px; color:#94a3b8;">No internal messages found.</p>'; return; }

            list.innerHTML = filtered.map(x => {
                let p = JSON.parse(x.message);
                return `
                    <div class="msg-row" onclick='viewM(${JSON.stringify(x).replace(/'/g, "&apos;")}, this)'>
                        <div class="msg-row-top">
                            <span class="msg-row-title">${p.title}</span>
                            <span class="msg-row-date">${new Date(x.created_at).toLocaleString()}</span>
                        </div>
                        <div class="msg-row-preview">${p.body}</div>
                    </div>
                `;
            }).join('');
        }

        function viewM(x, el) {
            document.querySelectorAll('.msg-row').forEach(r => r.classList.remove('active'));
            el.classList.add('active');
            let p = { title: "No Subject", body: "" };
            try { p = JSON.parse(x.message); } catch (e) { }
            document.getElementById('msgContentArea').innerHTML = `
                <div class="msg-view-header">
                    <h2 style="margin:0 0 10px 0; color:#1e293b;">${p.title}</h2>
                    <div style="font-size:0.8rem; color:#94a3b8;">To: ${x.users?.mobile || 'All Users'} | ${new Date(x.created_at).toLocaleString()}</div>
                </div>
                <div style="text-align:left; line-height:1.6; color:#475569; width:100%; white-space:pre-wrap;">${p.body}</div>
            `;
        }

        const STENCILS = [
            { id: 'spo_new', title: 'Capital Increase / Dividend Announcement', tag: 'spo:new', icon: 'megaphone', body: 'Congratulations! You have been awarded new shares as part of the second public offering.\nShare Name: {{name}}\nCapital Increase Type: Rights Issue\nExpected Yield: {{display_rate}}\nPlease check your account balance and the deadline for making the offer. Your new shares will be added to your portfolio automatically.' },
            { id: 'ipo_win', title: 'Congratulations on Your IPO Allocation!', tag: 'ipo:win', icon: 'party-popper', body: 'Congratulations! You have successfully been allocated shares in the IPO of {{company_name}}.\nAs a valued investor, we are pleased to notify you that your subscription was successful.' },
            { id: 'ipo_ann', title: 'IPO Announcement - {{name}}', tag: 'girlfriend:new', icon: 'info', body: 'We are pleased to inform you that the IPO for {{name}} is now open for subscription. Please find the key dates below:\nSubscription Start: {{start_date}}\nListing Date: {{listing_date}}' },
            { id: 'ipo_list', title: 'IPO Listed now!', tag: 'ipolist', icon: 'trending-up', body: 'IPO listed successfully! The shares are now available for trading in the secondary market.' },
            { id: 'kyc_approve', title: 'KYC Approval', tag: 'KYC', icon: 'check-circle', body: 'We are pleased to inform you that your Real-Name Authentication (KYC) has been approved. You can now access all features.' },
            { id: 'kyc_reject', title: 'KYC Rejection', tag: 'KYC', icon: 'x-circle', body: 'Your KYC submission was rejected due to unclear images or mismatched information. Please resubmit with clear documents.' },
            { id: 'dep_success', title: 'Deposit Success', tag: 'FINANCE', icon: 'arrow-down-circle', body: 'Your deposit has been successfully processed and credited to your account.' },
            { id: 'with_process', title: 'Withdrawal Processing', tag: 'FINANCE', icon: 'clock', body: 'Your withdrawal request has been received and is currently being processed by our finance team.' }
        ];

        function showMsgSection(s) {
            document.getElementById('btn_sent').classList.toggle('active', s === 'sent');
            document.getElementById('btn_stencil').classList.toggle('active', s === 'stencil');
            document.getElementById('msgMain').style.display = (s === 'sent' ? 'flex' : 'none');
            document.getElementById('msgStencilView').style.display = (s === 'stencil' ? 'block' : 'none');
            document.getElementById('stencilFilters').style.display = (s === 'stencil' ? 'flex' : 'none');
            if (s === 'stencil') renderStencils();
        }

        function renderStencils() {
            const grid = document.getElementById('stencilGrid');
            if (!grid) return;
            grid.innerHTML = STENCILS.map(s => `
                <div class="stencil-card" onclick="useStencil('${s.id}')">
                    <h4><i data-lucide="${s.icon || 'file-text'}" size="18"></i> ${s.title}</h4>
                    <span class="stencil-tag">${s.tag}</span>
                    <div class="stencil-preview">${s.body}</div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function useStencil(id) {
            const s = STENCILS.find(x => x.id === id);
            if (!s) return;
            openMsgModal();
            document.getElementById('newMsgTitle').value = s.title;
            document.getElementById('newMsgContent').value = s.body;
        }

        function filterMessages() {
            const q = document.getElementById('msgSearch').value.toLowerCase();
            // Filter logic here if needed for 'sent' messages
            const filtered = allMsgs.filter(m => {
                try { let p = JSON.parse(m.message); return p.title.toLowerCase().includes(q); } catch (e) { return false; }
            });
            renderMessages(filtered);
        }

        function switchPage(p) {
            if (!openTabs.includes(p)) openTabs.push(p);

            // Hide all pages
            document.querySelectorAll('.vsl-page').forEach(x => x.style.display = 'none');
            document.querySelectorAll('.menu-item, .sub-item').forEach(x => x.classList.remove('active'));

            let pageId = 'page' + p.charAt(0).toUpperCase() + p.slice(1);

            // Special case for Bank Accounts
            if (p === 'bank_accounts') {
                pageId = 'pageBankAccounts';
            }

            const pg = document.getElementById(pageId);
            if (pg) pg.style.display = 'block';

            const btn = document.getElementById('btn_' + p);
            if (btn) btn.classList.add('active');

            renderTabs();
            lucide.createIcons();

            if (p === 'livechat') initLiveChat();
            if (p === 'bank_accounts') loadBankAccounts();
            if (p === 'products') renderProducts();
            if (p === 'stock057') renderStock057();
        }




        async function loadBankAccounts() {
            const tbody = document.getElementById('bankAccountsTableBody');
            if (!tbody) return;

            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">Loading...</td></tr>';

            // Fetch from DB
            const res = await window.DB.getAllBankAccounts();

            if (!res || res.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px; color:#94a3b8;">No bank accounts found.</td></tr>';
                return;
            }

            tbody.innerHTML = res.map(acc => `
                <tr style="border-bottom:1px solid #f1f5f9;">
                    <td style="padding:12px;">${acc.user_id}</td>
                    <td style="padding:12px; font-weight:600;">${acc.first_name || '-'} ${acc.last_name || '-'}</td>
                    <td style="padding:12px;">${acc.bank_name || '-'}</td>
                    <td style="padding:12px; font-family:monospace;">${acc.account_number}</td>
                    <td style="padding:12px;">${acc.ifsc || '-'}</td>
                    <td style="padding:12px;">${acc.mobile || '-'}</td>
                    <td style="padding:12px; font-size:0.75rem; color:#64748b;">${acc.created_at ? new Date(acc.created_at).toLocaleString() : '-'}</td>
                </tr>
                `).join('');
        }

        // Live Chat Logic
        let currentChatUser = null;
        let chatUsers = [];
        let isAdminChatSubscribed = false;

        function playNotificationSound() {
            try {
                const audio = new Audio('https://notificationsounds.com/storage/sounds/file-sounds-1150-pristine.mp3');
                audio.volume = 0.5;
                const playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise.catch(e => console.log("Audio play blocked."));
                }
            } catch (e) { }
        }

        async function initLiveChat() {
            const client = DB.getClient();
            if (!client) return;

            // Fetch users with messages
            const { data: msgs } = await client.from('messages').select('user_id, created_at').order('created_at', { ascending: false }).limit(500);
            const uids = [...new Set(msgs.map(m => m.user_id))];
            chatUsers = allUsers.filter(u => uids.includes(u.id));
            renderChatUserList();

            if (!isAdminChatSubscribed) {
                // Unique channel name to avoid conflicts
                const chatChannel = client.channel('admin-chat-broadcaster')
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
                        const newMsg = payload.new;
                        console.log("New message received in backend:", newMsg);

                        // Notify if from User
                        if (newMsg.sender === 'User' || newMsg.sender === 'user') {
                            playNotificationSound();

                            // 1. Update overall badge
                            const badge = document.getElementById('chat_badge');
                            if (badge) {
                                const count = parseInt(badge.textContent || '0') + 1;
                                badge.textContent = count;
                                badge.style.display = 'block';
                            }

                            // 2. Mark user as unread
                            const targetU = chatUsers.find(u => String(u.id) === String(newMsg.user_id));
                            if (targetU && (!currentChatUser || String(currentChatUser.id) !== String(targetU.id))) {
                                targetU.unreadCount = (targetU.unreadCount || 0) + 1;
                            }
                        }

                        // If user is currently selected, show the message
                        if (currentChatUser && String(newMsg.user_id) === String(currentChatUser.id)) {
                            appendChatMessage(newMsg);
                        }
                        updateChatUserList(newMsg);
                    })
                    .subscribe();
                isAdminChatSubscribed = true;
            }
        }

        function renderChatUserList() {
            const list = document.getElementById('chatUserList');
            if (!list) return;
            list.innerHTML = chatUsers.map(u => {
                const isActive = currentChatUser && currentChatUser.id === u.id;
                const unread = u.unreadCount || 0;

                return `
                <div class="msg-row ${isActive ? 'active' : ''}" onclick="openChat('${u.id}')" style="display: flex; align-items: center; gap: 12px; padding: 15px 20px;">
                        <div style="width: 45px; height: 45px; border-radius: 50%; background: #f1f5f9; display: flex; align-items: center; justify-content: center; color: #64748b; font-weight: 700; flex-shrink: 0; font-size: 0.85rem; position: relative;">
                            ${(u.username || u.mobile || 'U').substring(0, 1).toUpperCase()}
                            ${unread > 0 ? `<div style="position: absolute; top: -2px; right: -2px; background: #ef4444; color: white; border: 2px solid white; border-radius: 50%; min-width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 800; animation: pulse-red-admin 2s infinite;">${unread}</div>` : ''}
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div class="msg-row-top" style="margin-bottom: 2px;">
                                <span class="msg-row-title" style="font-size: 0.85rem; font-weight: 700;">${u.mobile}</span>
                            </div>
                            <div class="msg-row-preview" style="font-size: 0.75rem; color: ${unread > 0 ? '#1e293b' : '#94a3b8'}; font-weight: ${unread > 0 ? '600' : '400'}; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                ${u.username || 'Investor Member'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        async function openChat(uid) {
            const user = allUsers.find(u => u.id == uid);
            if (!user) return;
            currentChatUser = user;

            // Clear unread for this specific user
            user.unreadCount = 0;

            document.getElementById('chatInputArea').style.display = 'flex';
            document.getElementById('chatWindowHeader').style.display = 'flex';
            document.getElementById('chatHeaderName').textContent = user.username || user.mobile;
            document.getElementById('chatHeaderAvatar').textContent = (user.username || user.mobile || 'U').substring(0, 1).toUpperCase();

            // Clear badge count if opening the chat tab or specific user
            // In this admin UI, we'll clear it when they open ANY chat or specifically the livechat tab
            const badge = document.getElementById('chat_badge');
            if (badge) {
                badge.style.display = 'none';
                badge.textContent = '0';
            }

            renderChatUserList();
            const msgs = await DB.getMessages(uid);
            renderChatHistory(msgs);
        }

        function renderChatHistory(msgs) {
            const hist = document.getElementById('chatHistory');
            hist.innerHTML = msgs.filter(m => {
                try { JSON.parse(m.message); return false; } catch (e) { return true; }
            }).map(m => {
                const isAdmin = m.sender === 'Admin';
                return `
                <div style="align-self: ${isAdmin ? 'flex-end' : 'flex-start'};
                                background: ${isAdmin ? '#3b82f6' : 'white'};
            color: ${isAdmin ? 'white' : '#1e293b'};
            padding: 10px 16px; border-radius: ${isAdmin ? '18px 18px 2px 18px' : '18px 18px 18px 2px'};
            max-width: 80%;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05); border: ${isAdmin ? 'none' : '1px solid #f1f5f9'};">
                <div style="font-size: 0.88rem; line-height: 1.5;">${m.message}</div>
                    <div style="font-size: 0.65rem; margin-top: 4px; opacity: 0.7; text-align: ${isAdmin ? 'right' : 'left'};">
                        ${new Date(m.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                    </div>
                </div>
                `;
            }).join('');
            hist.scrollTop = hist.scrollHeight;
        }

        function appendChatMessage(m) {
            try { JSON.parse(m.message); return; } catch (e) { }
            const hist = document.getElementById('chatHistory');
            const div = document.createElement('div');
            const isAdmin = m.sender === 'Admin';
            div.style.cssText = `align-self: ${isAdmin ? 'flex-end' : 'flex-start'};
            background: ${isAdmin ? '#3b82f6' : 'white'};
            color: ${isAdmin ? 'white' : '#1e293b'}; padding: 10px 16px;
            border-radius: ${isAdmin ? '18px 18px 2px 18px' : '18px 18px 18px 2px'}; max-width: 80%;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05); border: ${isAdmin ? 'none' : '1px solid #f1f5f9'};`;
            div.innerHTML = `<div style="font-size: 0.88rem; line-height: 1.5;">${m.message}</div>
                <div style="font-size: 0.65rem; margin-top: 4px; opacity: 0.7; text-align: ${isAdmin ? 'right' : 'left'};">
                    ${new Date(m.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                </div>`;
            hist.appendChild(div);
            hist.scrollTop = hist.scrollHeight;
        }

        function updateChatUserList(m) {
            const uid = m.user_id;
            const idx = chatUsers.findIndex(u => u.id === uid);
            if (idx > -1) { const u = chatUsers.splice(idx, 1)[0]; chatUsers.unshift(u); }
            else { const u = allUsers.find(u => u.id === uid); if (u) chatUsers.unshift(u); }
            renderChatUserList();
        }

        async function sendAdminChat() {
            const input = document.getElementById('adminChatInput');
            const msg = input.value.trim();
            if (!msg || !currentChatUser) return;

            input.value = '';
            await DB.sendMessage(currentChatUser.id, msg, 'Admin');
        }

        function filterChatUsers() {
            const q = document.getElementById('chatSearch').value.toLowerCase();
            const filtered = chatUsers.filter(u => u.mobile.includes(q));
            document.getElementById('chatUserList').innerHTML = filtered.map(u => `
                    <div class="msg-row ${currentChatUser && currentChatUser.id === u.id ? 'active' : ''}" onclick="openChat('${u.id}')">
                    <div class="msg-row-top"><span class="msg-row-title">${u.mobile}</span></div>
                    <div class="msg-row-preview">${u.username || 'Investor'}</div>
                </div>
                `).join('');
        }

        function renderTabs() {
            const container = document.getElementById('tabContainer');
            const active = Array.from(document.querySelectorAll('.vsl-page')).find(x => x.style.display !== 'none')?.id.replace('page', '').toLowerCase() || 'home';
            container.innerHTML = openTabs.map(t => `
                <div class="tab-tag ${t === active ? 'active' : ''}" onclick="switchPage('${t}')">
                    ${PAGE_NAMES[t] || t} ${t !== 'home' ? `<i data-lucide="x" size="12" onclick="event.stopPropagation(); closeTab('${t}')"></i>` : ''}
                </div>
                `).join('');
            lucide.createIcons();
        }

        function closeTab(p) {
            openTabs = openTabs.filter(t => t !== p);
            const active = Array.from(document.querySelectorAll('.vsl-page')).find(x => x.style.display !== 'none')?.id.replace('page', '').toLowerCase();
            if (active === p) switchPage(openTabs[openTabs.length - 1]); else renderTabs();
        }

        function openMsgModal() {
            const s = document.getElementById('msgTarget');
            s.innerHTML = '<option value="all">All Users</option>' + allUsers.map(u => `<option value="${u.id}">${u.mobile}</option>`).join('');
            document.getElementById('msgModal').style.display = 'flex';
        }

        let targetKycUser = null;

        async function openKycEdit(uid) {
            const client = DB.getClient();
            showLoader(true);
            const { data: user } = await client.from('users').select('*').eq('id', uid).single();
            const { data: kyc } = await client.from('kyc_submissions').select('*').eq('user_id', uid).order('submitted_at', { ascending: false }).limit(1).single();

            targetKycUser = uid;

            if (user) {
                document.getElementById('ek_name').value = user.username || '';
                document.getElementById('ek_fullname').value = user.full_name || '';
                document.getElementById('ek_idnum').value = user.id_number || '';
                document.getElementById('ek_phone').value = user.mobile || '';
                document.getElementById('ek_email').value = user.email || '';
                document.getElementById('ek_dob').value = user.dob || '';
                document.getElementById('ek_gender').value = user.gender || '';
                document.getElementById('ek_status').value = kyc ? kyc.status : 'Pending';
                document.getElementById('ek_pin').value = user.withdrawal_pin || '';
                document.getElementById('ek_notes').value = kyc ? (kyc.rejection_reason || '') : '';
            }

            if (kyc) {
                if (kyc.id_front_url) {
                    document.getElementById('ek_front_img').src = kyc.id_front_url;
                    document.getElementById('ek_front_img').style.display = 'block';
                    document.getElementById('ek_front_plus').style.display = 'none';
                } else {
                    document.getElementById('ek_front_img').style.display = 'none';
                    document.getElementById('ek_front_plus').style.display = 'block';
                }

                if (kyc.id_back_url) {
                    document.getElementById('ek_back_img').src = kyc.id_back_url;
                    document.getElementById('ek_back_img').style.display = 'block';
                    document.getElementById('ek_back_plus').style.display = 'none';
                } else {
                    document.getElementById('ek_back_img').style.display = 'none';
                    document.getElementById('ek_back_plus').style.display = 'block';
                }
                document.getElementById('ek_idnum').value = user.id_number || kyc.id_number || '';
            } else {
                document.getElementById('ek_front_img').style.display = 'none';
                document.getElementById('ek_front_plus').style.display = 'block';
                document.getElementById('ek_back_img').style.display = 'none';
                document.getElementById('ek_back_plus').style.display = 'block';
            }

            document.getElementById('editKycModal').style.display = 'flex';
            showLoader(false);
            setTimeout(() => lucide.createIcons(), 100);
        }

        function closeEditKyc() {
            document.getElementById('editKycModal').style.display = 'none';
        }

        async function saveEditKyc() {
            if (!targetKycUser) return;
            const newStatus = document.getElementById('ek_status').value;

            showConfirm(`Are you sure you want to update KYC status to ${newStatus}? Changes will be applied immediately.`, async () => {
                showLoader(true);
                const client = DB.getClient();

                try {
                    const updates = {
                        username: document.getElementById('ek_name').value,
                        full_name: document.getElementById('ek_fullname').value,
                        id_number: document.getElementById('ek_idnum').value,
                        mobile: document.getElementById('ek_phone').value,
                        email: document.getElementById('ek_email').value,
                        dob: document.getElementById('ek_dob').value,
                        gender: document.getElementById('ek_gender').value,
                        kyc: document.getElementById('ek_status').value,
                        withdrawal_pin: document.getElementById('ek_pin').value
                    };

                    const kycUpdates = {
                        status: updates.kyc,
                        id_front_url: document.getElementById('ek_front_img').src,
                        id_back_url: document.getElementById('ek_back_img').src
                    };

                    // Clean URLs
                    if (kycUpdates.id_front_url.includes('placeholder')) delete kycUpdates.id_front_url;
                    if (kycUpdates.id_back_url.includes('placeholder')) delete kycUpdates.id_back_url;

                    const { error: uErr } = await client.from('users').update(updates).eq('id', targetKycUser);
                    if (uErr) throw uErr;

                    // Check if kyc_submissions exists
                    const { data: existing } = await client.from('kyc_submissions').select('id').eq('user_id', targetKycUser).limit(1);
                    if (existing && existing.length > 0) {
                        const { error: kErr } = await client.from('kyc_submissions').update(kycUpdates).eq('user_id', targetKycUser);
                        if (kErr) throw kErr;
                    } else {
                        const { error: iErr } = await client.from('kyc_submissions').insert({ user_id: targetKycUser, ...kycUpdates });
                        if (iErr) throw iErr;
                    }

                    showSuccess("Investor KYC details updated successfully!");
                    closeEditKyc();
                    init();
                } catch (e) {
                    console.error("Save KYC Error:", e);
                    alert("Failed to update status: " + (e.message || "Unknown error"));
                    showLoader(false);
                }
            }, "Update KYC Status");
        }

        function showSuccess(msg) {
            const modal = document.getElementById('successModal');
            const msgEl = document.getElementById('successModalMsg');
            msgEl.textContent = msg;
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
            if (window.lucide) window.lucide.createIcons();
        }

        function closeSuccessModal() {
            const modal = document.getElementById('successModal');
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        async function uploadKycFile(input, side) {
            const file = input.files[0];
            if (!file) return;

            showLoader(true);
            const client = DB.getClient();
            const ext = file.name.split('.').pop();
            const filePath = `kyc / ${targetKycUser}_${side}_${Date.now()}.${ext} `;

            try {
                const { data, error } = await client.storage.from('kyc').upload(filePath, file);
                if (error) throw error;

                const { data: { publicUrl } } = client.storage.from('kyc').getPublicUrl(filePath);
                document.getElementById(`ek_${side} _img`).src = publicUrl;
                document.getElementById(`ek_${side} _img`).style.display = 'block';
                document.getElementById(`ek_${side} _plus`).style.display = 'none';
                alert(`Upload Successful: ${side} side updated.`);
            } catch (e) {
                console.error(e);
                alert("Upload failed. Ensure the 'kyc' bucket exists in Supabase Storage with public access.");
            } finally {
                showLoader(false);
            }
        }

        function removeKycImg(side) {
            document.getElementById(`ek_${side} _img`).src = '';
            document.getElementById(`ek_${side} _img`).style.display = 'none';
            document.getElementById(`ek_${side} _plus`).style.display = 'block';
        }

        async function sendMsg() {
            const tid = document.getElementById('msgTarget').value;
            const title = document.getElementById('msgTitle').value;
            const body = document.getElementById('msgBody').value;

            if (!title || !body) { alert("Please enter both title and message content."); return; }

            // Use 'Admin' sender to satisfy DB constraint, but add flag to distinguish from Chat
            const m = JSON.stringify({ title: title, body: body, is_notification: true });
            showLoader(true);
            const c = DB.getClient();

            let error = null;
            try {
                if (tid === 'all') {
                    // Batch insert could be large, but usually okay for < 1000
                    const { error: e } = await c.from('messages').insert(allUsers.map(u => ({ user_id: u.id, message: m, sender: 'Admin' })));
                    error = e;
                } else {
                    const { error: e } = await c.from('messages').insert({ user_id: parseInt(tid), message: m, sender: 'Admin' });
                    error = e;
                }
            } catch (err) {
                error = err;
            }

            showLoader(false);

            if (error) {
                console.error("Send Notification Error:", error);
                alert("Failed to send notification: " + (error.message || error));
                return;
            }

            alert("Notification sent successfully to User(s)!");
            document.getElementById('msgModal').style.display = 'none';
            init();
        }

        function openDepositModal(uid, uname) {
            document.getElementById('dep_id').value = '';
            document.getElementById('dep_user_id').value = uid;
            document.getElementById('dep_username').value = uname || 'User #' + uid;
            document.getElementById('dep_type').value = 'deposit';
            document.getElementById('dep_amount').value = '';
            document.getElementById('dep_status').value = 'Approved';
            document.getElementById('dep_note').value = 'Manual Transaction by Admin';
            document.getElementById('depositModal').style.display = 'flex';
            lucide.createIcons();
        }

        function openDepositEdit(id, uname, amount, status, note) {
            document.getElementById('dep_id').value = id;
            document.getElementById('dep_username').value = uname;
            document.getElementById('dep_amount').value = amount;
            document.getElementById('dep_status').value = status;
            document.getElementById('dep_note').value = note || '';
            document.getElementById('dep_type').value = 'deposit';
            document.getElementById('depositModal').style.display = 'flex';
            lucide.createIcons();
        }

        function closeDepositModal() {
            document.getElementById('depositModal').style.display = 'none';
        }

        function showConfirm(msg, onConfirm) {
            const modal = document.getElementById('confirmModal');
            const msgEl = document.getElementById('confirmModalMsg');
            const deleteBtn = document.getElementById('confirmDeleteBtn');

            msgEl.textContent = msg;
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);

            deleteBtn.onclick = () => {
                closeConfirmModal();
                onConfirm();
            };

            if (window.lucide) window.lucide.createIcons();
        }

        function closeConfirmModal() {
            const modal = document.getElementById('confirmModal');
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        function openWithdrawalEdit(id, uname, amount, status, note) {
            document.getElementById('wd_id').value = id;
            document.getElementById('wd_username').value = uname;
            document.getElementById('wd_amount').value = amount;
            document.getElementById('wd_status').value = status;
            document.getElementById('wd_note').value = note || '';
            document.getElementById('withdrawalModal').style.display = 'flex';
            lucide.createIcons();
        }

        function closeWithdrawalModal() {
            document.getElementById('withdrawalModal').style.display = 'none';
        }

        async function submitDeposit() {
            const depId = document.getElementById('dep_id').value;
            const uid = document.getElementById('dep_user_id').value;
            const amount = parseFloat(document.getElementById('dep_amount').value);
            const type = document.getElementById('dep_type').value;
            const status = document.getElementById('dep_status').value;
            const note = document.getElementById('dep_note').value;

            if (isNaN(amount) || amount < 0) {
                alert("Please enter a valid amount (0 or more).");
                return;
            }

            if (!depId && !uid) {
                alert("Missing user ID for new deposit.");
                return;
            }

            const isEdit = !!depId;
            const actionText = isEdit ? 'UPDATE' : (type === 'deposit' ? 'DEPOSIT (Add)' : 'SET BALANCE TO');

            showConfirm(`Are you sure you want to ${actionText} â‚¹${amount} with status ${status}?`, async () => {
                showLoader(true);
                const client = DB.getClient();

                try {
                    let actualUid = uid;
                    let oldStatus = 'Pending';
                    let oldAmount = 0;

                    if (isEdit) {
                        const { data: existing, error: getErr } = await client.from('deposits').select('*').eq('id', depId).single();
                        if (getErr) throw getErr;
                        actualUid = existing.user_id;
                        oldStatus = existing.status;
                        oldAmount = parseFloat(existing.amount);
                    }

                    // 1. Manage User Balance if status becomes APPROVED
                    if (status === 'Approved' && oldStatus !== 'Approved') {
                        const { data: user, error: uErr } = await client.from('users').select('*').eq('id', actualUid).single();
                        if (uErr) throw uErr;

                        const currentBalance = (typeof user.available_balance !== 'undefined') ? (parseFloat(user.available_balance) || 0) : (parseFloat(user.balance) || 0);
                        let newBalance = currentBalance;

                        if (type === 'deposit') {
                            newBalance = currentBalance + amount;
                        } else if (type === 'set') {
                            newBalance = amount;
                        }

                        const updates = { balance: newBalance };
                        if (typeof user.available_balance !== 'undefined') updates.available_balance = newBalance;

                        const { error: upErr } = await client.from('users').update(updates).eq('id', actualUid);
                        if (upErr) throw upErr;
                    }
                    // Handle case where it was Approved but now changed to something else (e.g. error correction)
                    else if (status !== 'Approved' && oldStatus === 'Approved') {
                        const { data: user, error: uErr } = await client.from('users').select('*').eq('id', actualUid).single();
                        if (uErr) throw uErr;

                        const currentBalance = (typeof user.available_balance !== 'undefined') ? (parseFloat(user.available_balance) || 0) : (parseFloat(user.balance) || 0);
                        const newBalance = currentBalance - oldAmount; // Reverse previous add

                        const updates = { balance: newBalance };
                        if (typeof user.available_balance !== 'undefined') updates.available_balance = newBalance;

                        const { error: upErr } = await client.from('users').update(updates).eq('id', actualUid);
                        if (upErr) throw upErr;
                    }

                    // 2. Insert or Update 'deposits' record (ONLY if type is 'deposit')
                    if (type === 'deposit') {
                        if (isEdit) {
                            const { error: upErr } = await client.from('deposits').update({
                                amount: amount,
                                status: status,
                                admin_note: note,
                                processed_at: new Date().toISOString()
                            }).eq('id', depId);
                            if (upErr) throw upErr;
                        } else {
                            const { error: insErr } = await client.from('deposits').insert({
                                user_id: parseInt(actualUid),
                                amount: amount,
                                status: status,
                                admin_note: note,
                                created_at: new Date().toISOString()
                            });
                            if (insErr) throw insErr;
                        }
                    }

                    alert("Transaction successful!");
                    closeDepositModal();
                    init();
                } catch (e) {
                    console.error(e);
                    alert("Error processing transaction: " + e.message);
                } finally {
                    showLoader(false);
                }
            });
        }

        async function quickActionWithdraw(id, status) {
            showConfirm(`Are you sure you want to ${status} this withdrawal?`, async () => {
                const note = status === 'Approved' ? 'Approved by Admin' : 'Rejected by Admin';
                await processWithdrawal(id, status, note);
            });
        }

        async function processWithdrawal(wdId, status, note) {
            showLoader(true);
            const client = DB.getClient();
            try {
                // 1. Get existing record
                const { data: existing, error: getErr } = await client.from('withdrawals').select('*').eq('id', wdId).single();
                if (getErr) throw getErr;

                // 2. Handle balance reverson if Rejected (Assuming balance was deducted on request)
                if (status === 'Rejected' && existing.status !== 'Rejected') {
                    const { data: user, error: uErr } = await client.from('users').select('balance').eq('id', existing.user_id).single();
                    if (uErr) throw uErr;
                    const newBalance = (parseFloat(user.balance) || 0) + parseFloat(existing.amount);
                    await client.from('users').update({ balance: newBalance }).eq('id', existing.user_id);
                }

                // 3. Update withdrawal record
                console.log("DB UPDATE: withdrawals.id=" + wdId + " | status=" + status);
                const { error: upErr } = await client.from('withdrawals').update({
                    status: status,
                    admin_note: note,
                    processed_at: new Date().toISOString()
                }).eq('id', wdId);
                if (upErr) throw upErr;

                // 4. Send Notification
                try {
                    const noticePacket = JSON.stringify({
                        title: status === 'Approved' ? 'Withdrawal Approved' : 'Withdrawal Rejected',
                        body: `Your withdrawal request for â‚¹${parseFloat(existing.amount).toFixed(2)} has been ${status.toLowerCase()}. ${status === 'Rejected' ? 'The amount has been credited back to your balance.' : ''}`,
                        is_notification: true
                    });
                    await client.from('messages').insert({ user_id: existing.user_id, message: noticePacket, sender: 'Admin' });
                } catch (ne) { console.error("Notice Error:", ne); }

                alert("Withdrawal successfully updated!");
                init();
            } catch (e) {
                console.error(e);
                alert("Error: " + e.message);
            } finally {
                showLoader(false);
            }
        }

        async function submitWithdrawalEdit() {
            const wdId = document.getElementById('wd_id').value;
            const status = document.getElementById('wd_status').value;
            const note = document.getElementById('wd_note').value;

            if (!wdId) return;

            showConfirm(`Update withdrawal status to ${status}?`, async () => {
                await processWithdrawal(wdId, status, note);
                closeWithdrawalModal();
            });
        }

        async function updateTradeStatus(id, newStatus) {
            const client = DB.getClient();
            showLoader(true);
            try {
                const { data: trade, error: tErr } = await client.from('trades').select('*').eq('id', id).single();
                if (tErr || !trade) throw new Error("Trade not found");

                const uid = trade.user_id;
                const amount = parseFloat(trade.total_amount);

                const { data: user, error: uErr } = await client.from('users').select('*').eq('id', uid).single();
                if (uErr || !user) throw new Error("User not found: " + uid);

                const currentBalance = (typeof user.available_balance !== 'undefined') ? (parseFloat(user.available_balance) || 0) : (parseFloat(user.balance) || 0);
                const currentInvested = parseFloat(user.invested) || 0;

                let newBalance = currentBalance;
                let newInvested = currentInvested;
                let shouldUpdateUser = false;

                if (trade.status === 'Pending' && newStatus === 'Settled') {
                    if (currentBalance < amount) {
                        alert(`Cannot approve: User (ID: ${uid}) has insufficient balance (â‚¹${currentBalance.toFixed(2)}) for this trade (â‚¹${amount.toFixed(2)}).`);
                        showLoader(false);
                        return;
                    }
                    newBalance -= amount;
                    newInvested += amount;
                    shouldUpdateUser = true;

                } else if (trade.status === 'Settled' && newStatus === 'Rejected') {
                    newBalance += amount;
                    newInvested -= amount;
                    shouldUpdateUser = true;

                } else if (trade.status === 'Rejected' && newStatus === 'Settled') {
                    if (currentBalance < amount) {
                        alert(`Cannot approve: User (ID: ${uid}) has insufficient balance (â‚¹${currentBalance.toFixed(2)}) for this trade (â‚¹${amount.toFixed(2)}).`);
                        showLoader(false);
                        return;
                    }
                    newBalance -= amount;
                    newInvested += amount;
                    shouldUpdateUser = true;
                }

                if (shouldUpdateUser) {
                    const updates = { balance: newBalance, invested: newInvested };
                    if (typeof user.available_balance !== 'undefined') updates.available_balance = newBalance;

                    const { error: upUserErr } = await client.from('users').update(updates).eq('id', uid);
                    if (upUserErr) throw new Error("Failed to update user balance: " + upUserErr.message);
                }

                const { error: upTradeErr } = await client.from('trades').update({
                    status: newStatus,
                    processed_at: new Date().toISOString()
                }).eq('id', id);

                if (upTradeErr) throw new Error("Failed to update trade status: " + upTradeErr.message);

                try {
                    const noticePacket = JSON.stringify({
                        title: newStatus === 'Settled' ? 'Trade Approved' : 'Trade Rejected',
                        message: `Your trade request for ${trade.name} (${trade.symbol}) has been ${newStatus === 'Settled' ? 'approved' : 'rejected'}.`,
                        is_notification: true
                    });
                    await DB.sendNotice(uid, "Trade Update", noticePacket);
                } catch (ne) { console.error(ne); }

                alert(`Trade #${id} successfully updated to ${newStatus}.`);
                init();

            } catch (e) {
                console.error(e);
                alert("Error updating trade: " + e.message);
            } finally {
                showLoader(false);
            }
        }

        function adminLogout() {
            showConfirm("Logout from admin terminal?", () => {
                sessionStorage.removeItem('admin_auth');
                window.location.href = 'admin_login.html';
            }, "Confirm Logout");
        }
        function toggleSub(id) { document.getElementById(id + 'Sub').classList.toggle('show'); }
        function showLoader(s) { document.getElementById('vslLoader').style.display = s ? 'flex' : 'none'; }

        // --- Product Management Logic ---
        let products = JSON.parse(localStorage.getItem('vsl_products') || '[]');

        function openAddProductModal() {
            console.log("Opening Add Product Modal...");
            const modal = document.getElementById('addProductModal');
            if (!modal) {
                console.error("Modal element not found!");
                return;
            }

            // Reset fields
            const fields = ['p_name', 'p_profit', 'p_price', 'p_start', 'p_end', 'p_listing', 'p_min', 'p_max', 'p_desc'];
            fields.forEach(f => {
                const el = document.getElementById(f);
                if (el) el.value = (f === 'p_min') ? '100000' : (f === 'p_max' ? '10000000' : '');
            });

            const premium = document.getElementById('p_premium');
            if (premium) premium.checked = false;

            modal.style.display = 'flex';
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function closeProductModal() {
            document.getElementById('addProductModal').style.display = 'none';
        }

        async function saveProduct() {
            const p = {
                name: document.getElementById('p_name').value,
                profit: document.getElementById('p_profit').value,
                price: parseFloat(document.getElementById('p_price').value) || 0,
                start_date: document.getElementById('p_start').value,
                end_date: document.getElementById('p_end').value,
                listing_date: document.getElementById('p_listing').value,
                min_invest: parseFloat(document.getElementById('p_min').value) || 0,
                max_invest: parseFloat(document.getElementById('p_max').value) || 0,
                is_premium: document.getElementById('p_premium').checked,
                description: document.getElementById('p_desc').value,
                type: 'IPO', // Can add selector if needed
                status: 'Active'
            };

            if (!p.name) { alert("Product Name is required!"); return; }

            showLoader(true);
            const { success, error } = await window.DB.saveProduct(p);
            showLoader(false);

            if (success) {
                alert("Product saved successfully to database!");
                closeProductModal();
                renderProducts();
            } else {
                alert("Failed to save product: " + (error?.message || "Unknown error"));
            }
        }

        async function renderProducts() {
            const list = document.getElementById('productList');
            if (!list) return;

            const dbProducts = await window.DB.getProducts();

            if (dbProducts.length === 0) {
                list.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:40px; color:#94a3b8;">No products found in database. Add one to see it here.</td></tr>';
                return;
            }
            list.innerHTML = dbProducts.map(p => `
                <tr style="border-bottom:1px solid #f1f5f9;">
                    <td style="padding:12px; font-weight:600;">${p.name}</td>
                    <td style="padding:12px; color:#10b981;">${p.profit || 'TBD'}</td>
                    <td style="padding:12px;">${p.listing_date || 'TBD'}</td>
                    <td style="padding:12px;"><span class="vsl-badge approved">${p.status}</span></td>
                    <td style="padding:12px;">
                        <button class="vsl-btn-small" style="background:#ef4444; color:white; border:none; cursor:pointer;" onclick="deleteProduct(${p.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        async function deleteProduct(id) {
            showConfirm("Are you sure you want to delete this product?", async () => {
                showLoader(true);
                const { success, error } = await window.DB.deleteProduct(id);
                showLoader(false);
                if (success) {
                    renderProducts();
                } else {
                    alert("Failed to delete product: " + (error?.message || "Unknown error"));
                }
            }, "Permanently Delete Product");
        }

        // --- Institutional Stock 057 Logic ---
        async function renderStock057() {
            const page = document.getElementById('pageStock057');
            if (!page) return;

            showLoader(true);
            const config = await window.DB.getPlatformSettings('institutional_config') || { status: 'Online', max_qty: 1000000 };
            showLoader(false);

            page.innerHTML = `
                <div class="vsl-header">
                    <h2 class="vsl-title">Institutional Stock 057</h2>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="section-card">
                        <h3>Configuration</h3>
                        <div class="fm-group">
                            <label>Terminal Status</label>
                            <select id="inst_status" class="vsl-input">
                                <option value="Online" ${config.status === 'Online' ? 'selected' : ''}>Online</option>
                                <option value="Maintenance" ${config.status === 'Maintenance' ? 'selected' : ''}>Maintenance</option>
                            </select>
                        </div>
                        <div class="fm-group">
                            <label>Max Quantity (Institutional)</label>
                            <input type="number" id="inst_max_qty" class="vsl-input" value="${config.max_qty}">
                        </div>
                        <button class="vsl-btn-primary" style="width:100%;" onclick="saveInstitutionalConfig()">Update Configuration</button>
                    </div>
                    <div class="section-card">
                        <h3>Active Terminals</h3>
                        <div class="vsl-table-wrap">
                            <table class="vsl-table" style="width:100%;">
                                <thead>
                                    <tr>
                                        <th>Terminal ID</th>
                                        <th>Location</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>T-057-01</td>
                                        <td>Mumbai Hub</td>
                                        <td><span class="vsl-badge approved">Active</span></td>
                                    </tr>
                                    <tr>
                                        <td>T-057-02</td>
                                        <td>Delhi DC</td>
                                        <td><span class="vsl-badge approved">Active</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        async function saveInstitutionalConfig() {
            const status = document.getElementById('inst_status').value;
            const max_qty = parseInt(document.getElementById('inst_max_qty').value) || 0;

            showLoader(true);
            const { success, error } = await window.DB.updatePlatformSettings('institutional_config', { status, max_qty });
            showLoader(false);

            if (success) {
                alert("Institutional configuration updated successfully!");
                renderStock057();
            } else {
                alert("Failed to update configuration: " + (error?.message || "Unknown error"));
            }
        }

        async function quickActionLoan(id, status) {
            // Strict Uppercase
            status = status.toUpperCase();

            showConfirm(`Are you sure you want to ${status} this loan?`, async () => {
                const note = status === 'APPROVED' ? 'Approved by Admin' : 'Rejected by Admin';

                showLoader(true);
                const res = await window.DB.updateLoanStatus(id, status, note);
                showLoader(false);

                if (res.success) {
                    alert(`Loan ${status} successfully!`);
                    // 3. Force reload
                    init();
                } else {
                    alert("Operation failed: " + (res.error?.message || "Unknown error"));
                }
            }, "Confirm Loan Action");
        }

        // Shared Confirm Logic
        function showConfirm(msg, onConfirm, title = "Confirm Action") {
            const modal = document.getElementById('confirmModal');
            const msgEl = document.getElementById('confirmModalMsg');
            const titleEl = document.getElementById('confirmModalTitle');
            const deleteBtn = document.getElementById('confirmDeleteBtn');

            if (titleEl) titleEl.textContent = title;
            if (msgEl) msgEl.textContent = msg;

            deleteBtn.onclick = () => {
                closeConfirmModal();
                onConfirm();
            };

            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
            if (window.lucide) window.lucide.createIcons();
        }

        function closeConfirmModal() {
            const modal = document.getElementById('confirmModal');
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        window.onload = () => { switchPage('home'); init(); };
    </script>

    <div id="addProductModal" class="vsl-modal">
        <div class="section-card" style="width:100%; max-width:600px; max-height:90vh; overflow-y:auto; margin:0;">
            <div
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem; border-bottom:1px solid #f1f5f9; padding-bottom:1rem;">
                <h3 style="margin:0;">Add New Product</h3>
                <button onclick="closeProductModal()" style="background:none; border:none; cursor:pointer;"><i
                        data-lucide="x"></i></button>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                <div class="fm-group" style="grid-column: span 2;">
                    <label>Product Name</label>
                    <input type="text" id="p_name" class="vsl-input" placeholder="e.g. Colgate-Palmolive India">
                </div>
                <div class="fm-group">
                    <label>Estimated Profit</label>
                    <input type="text" id="p_profit" class="vsl-input" placeholder="e.g. 31.39%">
                </div>
                <div class="fm-group">
                    <label>Allocation Price</label>
                    <input type="text" id="p_price" class="vsl-input" placeholder="e.g. 1648.88">
                </div>
                <div class="fm-group">
                    <label>Start Subscription</label>
                    <input type="datetime-local" id="p_start" class="vsl-input">
                </div>
                <div class="fm-group">
                    <label>End Subscription</label>
                    <input type="datetime-local" id="p_end" class="vsl-input">
                </div>
                <div class="fm-group">
                    <label>Listing Date</label>
                    <input type="date" id="p_listing" class="vsl-input">
                </div>
                <div class="fm-group">
                    <label>Minimum Investment</label>
                    <input type="number" id="p_min" class="vsl-input" placeholder="e.g. 100000">
                </div>
                <div class="fm-group">
                    <label>Maximum Investment</label>
                    <input type="number" id="p_max" class="vsl-input" placeholder="e.g. 10000000">
                </div>
                <div class="fm-group" style="grid-column: span 2; display:flex; align-items:center; gap:1rem;">
                    <label style="margin:0;">Enable High Premium Product</label>
                    <input type="checkbox" id="p_premium" style="width:20px; height:20px;">
                </div>
                <div class="fm-group" style="grid-column: span 2;">
                    <label>Product Details</label>
                    <textarea id="p_desc" class="vsl-input" style="height:100px; resize:none;"></textarea>
                </div>
            </div>
            <div style="margin-top:2rem; display:flex; justify-content:flex-end; gap:1rem;">
                <button onclick="closeProductModal()" class="vsl-btn-small"
                    style="background:#f1f5f9; color:#64748b;">Cancel</button>
                <button onclick="saveProduct()" class="vsl-btn-primary">Save Product</button>
            </div>
        </div>
    </div>

    <!-- SUCCESS MODAL -->
    <div id="successModal" class="success-modal-overlay">
        <div class="success-modal-card">
            <div class="success-modal-icon-box">
                <i data-lucide="check-circle" size="44"></i>
            </div>
            <h3 class="success-modal-title">Success!</h3>
            <p id="successModalMsg" class="success-modal-message"></p>
            <button class="success-modal-btn" onclick="closeSuccessModal()">Done</button>
        </div>
    </div>

    <!-- CONFIRM ACTION MODAL -->
    <div id="confirmModal" class="confirm-modal-overlay">
        <div class="confirm-modal-card">
            <div class="confirm-modal-icon-box">
                <i data-lucide="alert-triangle" size="44"></i>
            </div>
            <h3 id="confirmModalTitle" class="confirm-modal-title">Confirm Action</h3>
            <p id="confirmModalMsg" class="confirm-modal-message"></p>
            <div class="confirm-modal-footer">
                <button class="confirm-modal-btn cancel" onclick="closeConfirmModal()">Cancel</button>
                <button id="confirmDeleteBtn" class="confirm-modal-btn delete">Confirm</button>
            </div>
        </div>
    </div>
</body>

</html>